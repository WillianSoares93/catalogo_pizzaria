<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saborelli - Cardápio Online</title>
    <!-- Inclui a biblioteca Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inclui a biblioteca Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Estilos personalizados para efeitos visuais */
        .pizza-half {
            position: relative;
            overflow: hidden;
        }
        /* Pseudo-elementos para um leve efeito visual em metades de pizza (não usados diretamente na lógica atual) */
        .pizza-half::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            background-color: rgba(0,0,0,0.03);
            z-index: -1;
        }
        .pizza-half::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 50%;
            height: 100%;
            background-color: rgba(0,0,0,0.03);
            z-index: -1;
        }
        /* Animação para "virar" elementos ao aparecer */
        .flip-in {
            animation: flipIn 0.5s ease-out;
        }
        @keyframes flipIn {
            from { transform: rotateY(90deg); opacity: 0; }
            to { transform: rotateY(0); opacity: 1; }
        }
        /* Animação para "deslizar" elementos ao aparecer */
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Estilos para o modal principal */
        .modal {
            display: none; /* Oculto por padrão */
            position: fixed; /* Posição fixa na tela */
            z-index: 1000; /* Acima de outros elementos */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Habilita rolagem se o conteúdo for muito grande */
            background-color: rgba(0,0,0,0.4); /* Fundo escuro semitransparente */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Estilos para o modal de mensagem */
        .message-modal {
            display: none; /* Oculto por padrão */
            position: fixed; /* Posição fixa na tela */
            z-index: 1001; /* Acima de outros elementos */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Habilita rolagem se o conteúdo for muito grande */
            background-color: rgba(0,0,0,0.4); /* Fundo escuro semitransparente */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .message-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }

        /* Estilos para os desenhos de pizza no modal de seleção */
        .pizza-size-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border: 2px solid #e5e7eb; /* gray-200 */
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-align: center;
            min-width: 120px; /* Garante que os itens não fiquem muito pequenos */
        }
        .pizza-size-option:hover {
            border-color: #ef4444; /* red-500 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .pizza-size-option img { /* Alterado de svg para img */
            margin-bottom: 8px;
            width: 100px; /* Largura ajustada para retangular */
            height: 70px; /* Altura ajustada para retangular */
            object-fit: contain; /* Garante que a imagem se ajuste sem distorção */
        }

        /* Custom styles for sticky category bar on mobile */
        @media (max-width: 1023px) { /* Applies to screens smaller than 'lg' breakpoint */
            .category-bar-mobile-sticky {
                position: sticky;
                top: 0;
                z-index: 10;
                background-color: #f9fafb; /* bg-gray-50 */
                padding-top: 1rem; /* pt-4 */
                padding-bottom: 0.5rem; /* pb-2 */
                box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* subtle shadow */
            }
            /* Removed flex-direction: column and gap for horizontal layout on mobile */
            /* Removed overflow-x: hidden for horizontal scroll on mobile */
        }

        /* Adicionado para ajustar a rolagem para as seções, considerando a barra fixa */
        .pizza-category-section {
            scroll-margin-top: 6rem; /* Ajuste este valor se a altura da barra fixa mudar */
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Cabeçalho da página -->
        <header class="text-center mb-12">
            <h1 class="text-5xl font-bold text-red-600 mb-2">Sua Logo Aqui</h1>
            <p class="text-xl text-gray-600">Pizzaria Artesanal</p>
            <div class="w-24 h-1 bg-red-500 mx-auto mt-4"></div>
        </header>

        <!-- Conteúdo principal: Menu e Pedido -->
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Seção do Menu -->
            <div class="lg:w-2/3">
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Cardápio</h2>
                    
                    <!-- Mensagem "Arrasta para o lado" para mobile -->
                    <div class="text-gray-500 text-sm text-center mb-4 lg:hidden">
                        <i class="fas fa-hand-point-right mr-1"></i> Arraste para o lado para ver outras opções
                    </div>

                    <!-- Sticky Category Buttons Container -->
                    <div class="category-bar-mobile-sticky lg:static lg:p-0">
                        <div class="flex space-x-2 mb-6 overflow-x-auto pb-2 
                                    lg:flex-row lg:space-x-2 lg:mb-6 lg:overflow-visible lg:pb-0">
                            <button class="category-btn px-4 py-2 rounded-full bg-red-600 text-white whitespace-nowrap lg:flex-grow-0 lg:flex-shrink-0" data-category="tradicionais" data-target-id="tradicionais-section">Pizzas Tradicionais</button>
                            <button class="category-btn px-4 py-2 rounded-full bg-gray-200 text-gray-800 whitespace-nowrap lg:flex-grow-0 lg:flex-shrink-0" data-category="especiais" data-target-id="especiais-section">Pizzas Especiais</button>
                            <button class="category-btn px-4 py-2 rounded-full bg-gray-200 text-gray-800 whitespace-nowrap lg:flex-grow-0 lg:flex-shrink-0" data-category="doces" data-target-id="doces-section">Pizzas Doces</button>
                            <button class="category-btn px-4 py-2 rounded-full bg-gray-200 text-gray-800 whitespace-nowrap lg:flex-grow-0 lg:flex-shrink-0" data-category="bebidas" data-target-id="bebidas-section">Bebidas</button>
                        </div>
                    </div>
                    
                    <!-- Lista de Itens do Cardápio -->
                    <div id="pizza-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Conteúdo do cardápio será preenchido dinamicamente por JavaScript -->
                        <div id="tradicionais-section" class="pizza-category-section">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Pizzas Tradicionais</h3>
                        </div>
                        
                        <div id="especiais-section" class="pizza-category-section">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Pizzas Especiais</h3>
                        </div>
                        
                        <div id="doces-section" class="pizza-category-section">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Pizzas Doces</h3>
                        </div>
                        
                        <div id="bebidas-section" class="pizza-category-section">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Bebidas</h3>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Seção do Pedido (Carrinho) -->
            <div class="lg:w-1/3">
                <div class="bg-white rounded-lg shadow-md p-6 sticky top-4">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Seu Pedido</h2>
                    
                    <!-- Opções de Retirada/Entrega -->
                    <div class="mb-4">
                        <h4 class="font-bold text-gray-800 mb-2">Opções de Entrega:</h4>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" class="form-radio text-red-600" name="deliveryOption" value="pickup">
                                <span class="ml-2 text-gray-700">Retirada (Grátis)</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" class="form-radio text-red-600" name="deliveryOption" value="delivery" checked>
                                <span class="ml-2 text-gray-700">Entrega (R$ 5,00)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Itens adicionados ao pedido -->
                    <div id="order-items" class="mb-6">
                        <p class="text-gray-500 text-center py-4">Seu pedido está vazio</p>
                    </div>
                    
                    <!-- Resumo dos valores do pedido -->
                    <div class="border-t pt-4">
                        <div class="flex justify-between mb-2">
                            <span class="font-medium">Subtotal:</span>
                            <span id="subtotal" class="font-bold">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span class="font-medium">Taxa de entrega:</span>
                            <span id="delivery-fee" class="font-bold">R$ 5,00</span>
                        </div>
                        <div class="flex justify-between text-lg font-bold border-t pt-2 mt-2">
                            <span>Total:</span>
                            <span id="total">R$ 5,00</span>
                        </div>
                    </div>
                    
                    <!-- Botão para finalizar o pedido -->
                    <button id="checkout-btn" class="w-full mt-6 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition flex items-center justify-center">
                        <i class="fas fa-shopping-cart mr-2"></i> Finalizar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Botão "Ver Pedido" para mobile, aparece quando há itens no carrinho -->
    <button id="view-order-mobile-btn" class="fixed bottom-4 right-4 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 lg:hidden hidden flex items-center space-x-2">
        <i class="fas fa-receipt text-xl"></i> <span>Ver Pedido</span>
    </button>

    <!-- Modal de Seleção de Pizza (Inteira/Meia) -->
    <div id="pizza-option-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-pizza-option-modal">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="modal-pizza-name"></h3>
            <p class="text-gray-600 mb-6" id="modal-pizza-description"></p>
            <div id="pizza-size-options" class="grid grid-cols-1 sm:grid-cols-3 gap-4 justify-items-center">
                <!-- Opções de tamanho e "meia a meia" serão inseridas aqui pelo JS -->
            </div>
        </div>
    </div>

    <!-- Modal de Mensagem (para feedback do usuário) -->
    <div id="message-modal" class="message-modal">
        <div class="modal-content">
            <span class="close-button" id="close-message-modal">&times;</span>
            <p class="text-lg font-semibold text-gray-800 mb-4" id="message-modal-text"></p>
            <button id="ok-message-modal" class="px-4 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">OK</button>
        </div>
    </div>

    <!-- Modal de Sugestão de Bebidas -->
    <div id="drink-suggestion-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-drink-suggestion-modal">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Que tal adicionar uma bebida?</h3>
            <p class="text-gray-600 mb-6">Seu pedido não contém bebidas. Gostaria de adicionar alguma?</p>
            <div id="suggested-drinks-list" class="flex flex-col gap-3 mb-6">
                <!-- Sugestões de bebidas serão inseridas aqui via JS -->
            </div>
            <button id="proceed-without-drinks" class="px-6 py-3 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600 transition w-full">
                Continuar sem bebidas
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Dados do cardápio centralizados em JavaScript
            const pizzaMenuData = [
                {
                    name: "Margherita",
                    description: "Molho de tomate, mussarela, manjericão fresco",
                    basePrice: 45.90, // Preço para 8 fatias
                    category: "tradicionais",
                    isPizza: true
                },
                {
                    name: "Calabresa",
                    description: "Molho de tomate, mussarela, calabresa, cebola",
                    basePrice: 48.90,
                    category: "tradicionais",
                    isPizza: true
                },
                {
                    name: "Quatro Queijos",
                    description: "Molho de tomate, mussarela, provolone, parmesão, gorgonzola",
                    basePrice: 52.90,
                    category: "tradicionais",
                    isPizza: true
                },
                {
                    name: "Portuguesa",
                    description: "Molho de tomate, mussarela, presunto, ovos, cebola, azeitonas",
                    basePrice: 54.90,
                    category: "tradicionais",
                    isPizza: true
                },
                {
                    name: "Frango com Catupiry",
                    description: "Molho de tomate, mussarela, frango desfiado, catupiry",
                    basePrice: 56.90,
                    category: "especiais",
                    isPizza: true
                },
                {
                    name: "Pepperoni",
                    description: "Molho de tomate, mussarela, pepperoni, pimentão",
                    basePrice: 58.90,
                    category: "especiais",
                    isPizza: true
                },
                {
                    name: "Vegetariana",
                    description: "Molho de tomate, mussarela, berinjela, abobrinha, pimentão, champignon",
                    basePrice: 55.90,
                    category: "especiais",
                    isPizza: true
                },
                {
                    name: "Bacon Supreme",
                    description: "Molho de tomate, mussarela, bacon, milho, cebola caramelizada",
                    basePrice: 59.90,
                    category: "especiais",
                    isPizza: true
                },
                {
                    name: "Chocolate com Morango",
                    description: "Chocolate ao leite, morangos frescos",
                    basePrice: 49.90,
                    category: "doces",
                    isPizza: true
                },
                {
                    name: "Romeu e Julieta",
                    description: "Goiabada, mussarela, canela em pó",
                    basePrice: 47.90,
                    category: "doces",
                    isPizza: true
                },
                {
                    name: "Banana Caramelada",
                    description: "Banana, doce de leite, canela",
                    basePrice: 46.90,
                    category: "doces",
                    isPizza: true
                },
            ];

            const drinkMenuData = [
                { name: 'Refrigerante 600ml', price: 8.90, description: 'Coca-Cola, Guaraná, Fanta, Sprite', category: 'bebidas', isPizza: false },
                { name: 'Suco Natural 500ml', price: 10.90, description: 'Laranja, Maracujá, Limão, Abacaxi', category: 'bebidas', isPizza: false },
                { name: 'Cerveja Long Neck', price: 12.00, description: 'Heineken, Stella Artois, Budweiser', category: 'bebidas', isPizza: false },
                { name: 'Água Mineral', price: 4.00, description: 'Garrafa 500ml, sem gás', category: 'bebidas', isPizza: false },
                { name: 'Água Mineral com Gás', price: 5.00, description: 'Garrafa 500ml, com gás', category: 'bebidas', isPizza: false },
                { name: 'H2OH! Limão', price: 7.50, description: 'Garrafa 500ml', category: 'bebidas', isPizza: false },
                { name: 'Chá Gelado (Limoneto)', price: 6.00, description: 'Lipton Chá Gelado Limão 300ml', category: 'bebidas', isPizza: false },
                { name: 'Energetico (250ml)', price: 13.00, description: 'Red Bull, Monster', category: 'bebidas', isPizza: false },
                { name: 'Cerveja Artesanal (IPA)', price: 25.00, description: 'Cerveja India Pale Ale, 500ml', category: 'bebidas', isPizza: false },
                { name: 'Vinho Tinto (Taça)', price: 18.00, description: 'Vinho da Casa, Taça 180ml', category: 'bebidas', isPizza: false }
            ];

            // Seleciona todos os botões de categoria e todos os itens de pizza
            const categoryBtns = document.querySelectorAll('.category-btn');
            const categorySections = document.querySelectorAll('.pizza-category-section');
            
            // Adiciona um listener de clique para cada botão de categoria
            categoryBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.dataset.category;
                    const targetId = this.dataset.targetId;
                    
                    // Define o botão ativo imediatamente no clique
                    setActiveCategoryButton(category);

                    // Define a flag para ignorar temporariamente o IntersectionObserver
                    isScrollingFromClick = true;

                    // Rola para a seção de destino com comportamento suave
                    document.getElementById(targetId).scrollIntoView({ behavior: 'smooth', block: 'start' });

                    // Após um pequeno atraso, redefine a flag e reavalia a categoria ativa
                    setTimeout(() => {
                        isScrollingFromClick = false;
                        // Força uma reavaliação da categoria ativa após a rolagem, garantindo o estado correto
                        // Disparar um evento de rolagem fará com que o IntersectionObserver reavalie.
                        window.dispatchEvent(new Event('scroll'));
                    }, 700); // 700ms é um bom equilíbrio para rolagem suave
                });
            });
            
            // Funcionalidade do Carrinho de Pedidos
            let order = []; // Array para armazenar os itens do pedido
            const orderItemsEl = document.getElementById('order-items');
            const subtotalEl = document.getElementById('subtotal');
            const totalEl = document.getElementById('total');
            const deliveryFeeEl = document.getElementById('delivery-fee'); // Elemento para exibir a taxa de entrega
            let currentDeliveryFee = 5.00; // Taxa de entrega inicial
            const whatsappNumber = '5587996070638'; // Número de WhatsApp para envio do pedido

            // Referências para os radio buttons de entrega
            const deliveryOptionRadios = document.querySelectorAll('input[name="deliveryOption"]');

            // Referências para o modal de seleção de pizza
            const pizzaOptionModal = document.getElementById('pizza-option-modal');
            const closePizzaOptionModalBtn = document.getElementById('close-pizza-option-modal');
            const modalPizzaName = document.getElementById('modal-pizza-name');
            const modalPizzaDescription = document.getElementById('modal-pizza-description');
            const pizzaSizeOptions = document.getElementById('pizza-size-options'); // Referência para o contêiner de opções de tamanho

            // Referências para o modal de mensagem
            const messageModal = document.getElementById('message-modal');
            const closeMessageModalBtn = document.getElementById('close-message-modal');
            const okMessageModalBtn = document.getElementById('ok-message-modal');
            const messageModalText = document.getElementById('message-modal-text');

            // Referências para o modal de sugestão de bebidas
            const drinkSuggestionModal = document.getElementById('drink-suggestion-modal');
            const closeDrinkSuggestionModalBtn = document.getElementById('close-drink-suggestion-modal');
            const suggestedDrinksList = document.getElementById('suggested-drinks-list');
            const proceedWithoutDrinksBtn = document.getElementById('proceed-without-drinks');

            // Referência para o botão "Ver Pedido" mobile
            const viewOrderMobileBtn = document.getElementById('view-order-mobile-btn');

            let currentPizzaData = {}; // Objeto para armazenar temporariamente os dados da pizza selecionada
            let firstHalfPizza = null; // Armazena os dados da primeira metade de uma pizza dividida
            let isSelectingSecondHalf = false; // Flag para indicar se o usuário está escolhendo a segunda metade

            // Define tamanhos e seus multiplicadores de preço em relação ao preço de 8 fatias
            const sizes = [
                { slices: 4, label: '4 Fatias', multiplier: 0.7 },
                { slices: 6, label: '6 Fatias', multiplier: 0.85 },
                { slices: 8, label: '8 Fatias', multiplier: 1.0 }
            ];

            // Função para gerar a imagem de uma fatia de pizza
            function getGenericPizzaSliceImage() {
                // Usando o caminho relativo para a imagem no mesmo repositório
                return `
                    <img src="icon fatia.avif" 
                         alt="Fatia de Pizza" 
                         onerror="this.onerror=null;this.src='https://placehold.co/100x70/cccccc/000000?text=Pizza';" />
                `;
            }

            // Função para exibir o modal de mensagem
            function showMessageModal(message) {
                messageModalText.textContent = message;
                messageModal.style.display = 'flex'; // Usa flexbox para centralizar
            }

            // Função para ocultar o modal de mensagem
            function hideMessageModal() {
                messageModal.style.display = 'none';
            }

            // Listeners para fechar o modal de mensagem
            closeMessageModalBtn.addEventListener('click', hideMessageModal);
            okMessageModalBtn.addEventListener('click', hideMessageModal);
            window.addEventListener('click', function(event) {
                if (event.target == messageModal) {
                    hideMessageModal();
                }
            });

            // Function to set active category button
            function setActiveCategoryButton(category) {
                categoryBtns.forEach(btn => {
                    if (btn.dataset.category === category) {
                        btn.classList.remove('bg-gray-200', 'text-gray-800');
                        btn.classList.add('bg-red-600', 'text-white');
                        // Rola o botão ativo para a visualização se estiver na área rolável
                        btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    } else {
                        btn.classList.remove('bg-red-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-800');
                    }
                });
            }

            // Flag para prevenir que o IntersectionObserver sobrescreva eventos de clique
            let isScrollingFromClick = false; 
            // Armazena a categoria ativa atual determinada pela rolagem para evitar cintilação
            let currentActiveCategoryByScroll = 'tradicionais'; 

            // Function to get the current sticky header height dynamically
            function getStickyHeaderHeight() {
                const stickyHeader = document.querySelector('.category-bar-mobile-sticky');
                // Use offsetHeight for accurate height including padding and border
                return stickyHeader ? stickyHeader.offsetHeight : 0;
            }

            // O IntersectionObserver para destaque de categoria
            const categoryObserver = new IntersectionObserver((entries) => {
                if (isScrollingFromClick) {
                    return; // Ignora eventos do observer se estivermos rolando devido a um clique
                }

                let newActiveCategory = null;
                const stickyHeaderHeight = getStickyHeaderHeight();
                let bestMatchTop = Infinity; // Para encontrar a seção cujo topo está mais próximo do cabeçalho fixo

                // Itera sobre todas as seções para encontrar a que está atualmente mais visível no topo
                categorySections.forEach(section => {
                    const rect = section.getBoundingClientRect();
                    const category = section.id.replace('-section', '');
                    const h3 = section.querySelector('h3'); // Pega o título da seção
                    if (!h3) return; // Se não houver h3, ignora

                    const h3Rect = h3.getBoundingClientRect();

                    // Queremos a seção cujo título (h3) está no topo da área visível,
                    // logo abaixo da barra de categorias fixa.
                    // Adiciona um pequeno buffer para a detecção ser mais suave.
                    const detectionLine = stickyHeaderHeight + 10; // 10px abaixo do cabeçalho fixo

                    // Se o título da seção está cruzando a linha de detecção ou está logo acima dela
                    // e ainda visível, e é o mais alto (menor valor de top) até agora.
                    if (h3Rect.top <= detectionLine && h3Rect.bottom > 0) {
                        if (h3Rect.top < bestMatchTop) {
                            bestMatchTop = h3Rect.top;
                            newActiveCategory = category;
                        }
                    }
                });

                // Fallback para o caso de nenhuma seção estar perfeitamente alinhada ou no topo da página
                if (!newActiveCategory && categorySections.length > 0) {
                    // Se estiver no topo da página, ative a primeira categoria
                    if (window.scrollY <= stickyHeaderHeight + 20) { // Um pouco mais de buffer para o topo
                        newActiveCategory = 'tradicionais';
                    } else {
                        // Se não encontrou uma categoria ativa pelo h3, procura a seção que está mais ao topo
                        // e ainda visível, para o caso de rolagem rápida ou no final da página.
                        let closestToTop = Infinity;
                        for (let i = 0; i < categorySections.length; i++) {
                            const section = categorySections[i];
                            const rect = section.getBoundingClientRect();
                            const category = section.id.replace('-section', '');
                            
                            // Se a seção está visível
                            if (rect.bottom > 0 && rect.top < window.innerHeight) {
                                // E o seu topo está mais próximo do topo da viewport (ajustado pelo stickyHeaderHeight)
                                if (Math.abs(rect.top - stickyHeaderHeight) < closestToTop) {
                                    closestToTop = Math.abs(rect.top - stickyHeaderHeight);
                                    newActiveCategory = category;
                                }
                            }
                        }
                    }
                }
                
                if (newActiveCategory && newActiveCategory !== currentActiveCategoryByScroll) {
                    setActiveCategoryButton(newActiveCategory);
                    currentActiveCategoryByScroll = newActiveCategory;
                }
            }, {
                root: null, // O viewport
                rootMargin: `-${getStickyHeaderHeight()}px 0px 0px 0px`,
                threshold: 0.1 // Um pequeno limite para acionar a observação
            });

            // Observa cada seção de categoria
            categorySections.forEach(section => {
                categoryObserver.observe(section);
            });

            // IntersectionObserver para o botão "Ver Pedido"
            const orderSectionObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    // Se a seção do pedido está visível na tela e há itens no pedido, esconde o botão
                    if (entry.isIntersecting && order.length > 0) {
                        viewOrderMobileBtn.classList.add('hidden');
                    } else if (!entry.isIntersecting && order.length > 0) {
                        // Se a seção do pedido não está visível e há itens no pedido, mostra o botão
                        viewOrderMobileBtn.classList.remove('hidden');
                    } else if (order.length === 0) {
                        // Se o pedido está vazio, sempre esconde o botão
                        viewOrderMobileBtn.classList.add('hidden');
                    }
                });
            }, {
                root: null, // O viewport
                threshold: 0.1 // Dispara quando 10% do elemento está visível
            });

            // Observa a seção do pedido (o elemento pai que contém os itens do pedido)
            const orderSectionContainer = document.querySelector('.lg\\:w-1\\/3'); // Seleciona a div que contém o carrinho
            if (orderSectionContainer) {
                orderSectionObserver.observe(orderSectionContainer);
            }

            // Adiciona um listener de rolagem para atualizações mais imediatas,
            // embora o IntersectionObserver deva lidar com a maioria dos casos.
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    // Isso fará com que os IntersectionObservers reavaliem suas interseções.
                }, 50); // Debounce eventos de rolagem
            });

            // Listener de evento para os radio buttons de opção de entrega
            deliveryOptionRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'delivery') {
                        currentDeliveryFee = 5.00;
                    } else {
                        currentDeliveryFee = 0.00;
                    }
                    updateOrderDisplay(); // Recalcula o total com a nova taxa
                });
            });


            // Função para enviar o pedido para o WhatsApp
            function sendOrderToWhatsapp() {
                let orderMessage = `Boa noite, esse será meu pedido!\n\n*Itens:*\n`;
                order.forEach(item => {
                    let line = '';
                    if (item.selected_slices) { // Verifica se é um item de pizza pela presença de selected_slices
                        const sizeLabel = `${item.selected_slices} FATIAS`.toUpperCase();
                        if (item.type === 'half_pending') {
                            line = `- *${sizeLabel}*: ${item.name} (Aguardando 2ª metade) - R$ ${item.price.toFixed(2).replace('.', ',')}`;
                        } else {
                            line = `- *${sizeLabel}*: ${item.name} - R$ ${item.price.toFixed(2).replace('.', ',')}`; // Incluindo o preço
                        }
                    } else {
                        // Para outros itens (como bebidas), usa o formato original
                        line = `- ${item.name}: R$ ${item.price.toFixed(2).replace('.', ',')}`;
                    }
                    orderMessage += `${line}\n`;
                });

                const subtotal = order.reduce((sum, item) => sum + item.price, 0);
                const total = subtotal + currentDeliveryFee; // Usa a taxa de entrega atual

                orderMessage += `\n*Resumo:*\n`;
                orderMessage += `Subtotal: R$ ${subtotal.toFixed(2).replace('.', ',')}\n`;
                orderMessage += `Taxa de entrega: R$ ${currentDeliveryFee.toFixed(2).replace('.', ',')}\n`; // Exibe a taxa de entrega atual
                orderMessage += `Total: R$ ${total.toFixed(2).replace('.', ',')}`;

                const encodedMessage = encodeURIComponent(orderMessage);
                const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
                window.open(whatsappUrl, '_blank'); // Abre o WhatsApp em uma nova aba

                // Reseta o pedido após o envio
                order = [];
                updateOrderDisplay();
            }

            // Função para verificar bebidas e sugerir
            function checkAndSuggestDrinks() {
                if (isSelectingSecondHalf) {
                    showMessageModal('Por favor, escolha a segunda metade da sua pizza antes de finalizar o pedido.');
                    return;
                }
                if (order.length === 0) {
                    showMessageModal('Seu pedido está vazio. Adicione itens antes de finalizar.');
                    return;
                }

                const hasDrinks = order.some(item => item.category === 'bebidas');

                if (!hasDrinks) {
                    // Limpa sugestões anteriores
                    suggestedDrinksList.innerHTML = '';
                    // Popula e mostra o modal de sugestão de bebidas
                    drinkMenuData.forEach(drink => { // Usando drinkMenuData para sugestões
                        const drinkBtn = document.createElement('button');
                        drinkBtn.className = 'px-4 py-2 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600 transition w-full';
                        drinkBtn.textContent = `Adicionar ${drink.name} (R$ ${drink.price.toFixed(2).replace('.', ',')})`;
                        drinkBtn.addEventListener('click', () => {
                            addToOrder(drink);
                            drinkSuggestionModal.style.display = 'none';
                            sendOrderToWhatsapp(); // Envia para o WhatsApp após adicionar a bebida
                        });
                        suggestedDrinksList.appendChild(drinkBtn);
                    });
                    drinkSuggestionModal.style.display = 'flex';
                } else {
                    // Se houver bebidas, prossegue com a finalização do pedido
                    sendOrderToWhatsapp(); // Envia para o WhatsApp
                }
            }

            // Função para lidar com o clique no botão "Adicionar"
            function handleAddButtonClick(e) {
                const name = e.target.dataset.name;
                const price = parseFloat(e.target.dataset.price); // Este é o preço base (8 fatias)
                const description = e.target.dataset.description;
                const isPizza = e.target.dataset.isPizza === 'true';

                const categorySection = e.target.closest('.pizza-category-section');
                let category = 'outros';
                if (categorySection) {
                    category = categorySection.id.replace('-section', '');
                }

                if (isSelectingSecondHalf) {
                    if (!isPizza) {
                        showMessageModal('Por favor, escolha uma pizza para a segunda metade.');
                        return;
                    }

                    const pendingHalfIndex = order.findIndex(item => item.id === 'pending-half-pizza');
                    if (pendingHalfIndex > -1) {
                        order.splice(pendingHalfIndex, 1);
                    }

                    const cleanFirstName = firstHalfPizza.name;
                    const combinedName = `Meia ${cleanFirstName} & Meia ${name}`;
                    
                    const multiplierForTargetSlices = sizes.find(s => s.slices === firstHalfPizza.selected_slices).multiplier;
                    const selectedSecondHalfPrice = price * multiplierForTargetSlices; 

                    const combinedPrice = (firstHalfPizza.original_full_price / 2) + (selectedSecondHalfPrice / 2);
                    const combinedDescription = `${firstHalfPizza.description.replace('Primeira metade: ', '')} e ${description}`;

                    addToOrder({
                        type: 'split',
                        name: combinedName,
                        price: combinedPrice,
                        description: combinedDescription,
                        category: 'tradicionais',
                        selected_slices: firstHalfPizza.selected_slices
                    });

                    firstHalfPizza = null;
                    isSelectingSecondHalf = false;
                    showMessageModal('Pizza meio a meio adicionada ao pedido!');

                } else if (isPizza) {
                    currentPizzaData = { name, price, description, category };
                    modalPizzaName.textContent = name;
                    modalPizzaDescription.textContent = description;

                    pizzaSizeOptions.innerHTML = '';
                    
                    sizes.forEach(size => {
                        const sizePrice = currentPizzaData.price * size.multiplier;
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'pizza-size-option';
                        optionDiv.innerHTML = `
                            ${getGenericPizzaSliceImage()}
                            <span class="font-bold text-lg text-gray-800">${size.label}</span>
                            <span class="text-red-600 font-bold">R$ ${sizePrice.toFixed(2).replace('.', ',')}</span>
                            <div class="flex flex-col gap-2 mt-2 w-full">
                                <button class="add-full-size-pizza-btn px-4 py-2 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700 transition">
                                    Adicionar Inteira
                                </button>
                                <button class="add-half-size-pizza-btn px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition">
                                    Adicionar Meia Pizza
                                </button>
                            </div>
                        `;
                        pizzaSizeOptions.appendChild(optionDiv);

                        optionDiv.querySelector('.add-full-size-pizza-btn').addEventListener('click', function() {
                            addToOrder({
                                type: 'full',
                                name: currentPizzaData.name,
                                price: sizePrice,
                                description: currentPizzaData.description,
                                category: currentPizzaData.category,
                                selected_slices: size.slices
                            });
                            pizzaOptionModal.style.display = 'none';
                        });

                        optionDiv.querySelector('.add-half-size-pizza-btn').addEventListener('click', function() {
                            firstHalfPizza = {
                                name: currentPizzaData.name,
                                price: sizePrice / 2,
                                description: currentPizzaData.description,
                                original_full_price: sizePrice,
                                selected_slices: size.slices,
                                category: currentPizzaData.category
                            };
                            isSelectingSecondHalf = true;
                            pizzaOptionModal.style.display = 'none';
                            addToOrder({
                                type: 'half_pending',
                                name: `½ ${currentPizzaData.name}`,
                                price: sizePrice / 2,
                                description: `Primeira metade: ${currentPizzaData.description}`,
                                id: 'pending-half-pizza',
                                category: currentPizzaData.category,
                                selected_slices: size.slices
                            });
                            showMessageModal('Agora, escolha a segunda metade da sua pizza.');
                        });
                    });

                    pizzaOptionModal.style.display = 'flex';
                } else {
                    addToOrder({
                        type: 'full',
                        name,
                        price,
                        description,
                        category
                    });
                }
            }

            // Função para anexar os event listeners aos botões "Adicionar"
            function attachAddButtonListeners() {
                document.querySelectorAll('.add-pizza-btn').forEach(button => {
                    // Remove o listener anterior para evitar duplicações
                    button.removeEventListener('click', handleAddButtonClick); 
                    button.addEventListener('click', handleAddButtonClick);
                });
            }

            // Função para popular o cardápio dinamicamente
            function populateMenu() {
                // Limpa as seções existentes antes de preencher
                document.getElementById('tradicionais-section').innerHTML = '<h3 class="text-xl font-bold text-gray-800 mb-4">Pizzas Tradicionais</h3>';
                document.getElementById('especiais-section').innerHTML = '<h3 class="text-xl font-bold text-gray-800 mb-4">Pizzas Especiais</h3>';
                document.getElementById('doces-section').innerHTML = '<h3 class="text-xl font-bold text-gray-800 mb-4">Pizzas Doces</h3>';
                document.getElementById('bebidas-section').innerHTML = '<h3 class="text-xl font-bold text-gray-800 mb-4">Bebidas</h3>';

                // Popula Pizzas
                pizzaMenuData.forEach(item => {
                    const sectionEl = document.getElementById(`${item.category}-section`);
                    if (sectionEl) {
                        let priceString = '';
                        // Calcula e formata os preços para todos os tamanhos de pizza
                        const price4F = (item.basePrice * sizes.find(s => s.slices === 4).multiplier).toFixed(2).replace('.', ',');
                        const price6F = (item.basePrice * sizes.find(s => s.slices === 6).multiplier).toFixed(2).replace('.', ',');
                        const price8F = item.basePrice.toFixed(2).replace('.', ',');
                        priceString = `4F: R$ ${price4F} | 6F: R$ ${price6F} | 8F: R$ ${price8F}`;
                        

                        const itemHtml = `
                            <div class="pizza-item bg-white border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                                <div class="p-4">
                                    <h4 class="font-bold text-lg text-gray-800">${item.name}</h4>
                                    <p class="text-gray-600 text-sm mb-3">${item.description}</p>
                                    <div class="flex justify-between items-center">
                                        <span class="font-bold text-red-600">${priceString}</span>
                                        <button class="add-pizza-btn px-3 py-1 bg-red-600 text-white rounded-full text-sm hover:bg-red-700 transition"
                                                data-name="${item.name}"
                                                data-price="${item.basePrice}"
                                                data-description="${item.description}"
                                                data-is-pizza="${item.isPizza}">
                                            Adicionar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        sectionEl.insertAdjacentHTML('beforeend', itemHtml);
                    }
                });

                // Popula Bebidas
                drinkMenuData.forEach(item => {
                    const sectionEl = document.getElementById(`${item.category}-section`);
                    if (sectionEl) {
                        const itemHtml = `
                            <div class="pizza-item bg-white border rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                                <div class="p-4">
                                    <h4 class="font-bold text-lg text-gray-800">${item.name}</h4>
                                    <p class="text-gray-600 text-sm mb-3">${item.description}</p>
                                    <div class="flex justify-between items-center">
                                        <span class="font-bold text-red-600">R$ ${item.price.toFixed(2).replace('.', ',')}</span>
                                        <button class="add-pizza-btn px-3 py-1 bg-red-600 text-white rounded-full text-sm hover:bg-red-700 transition"
                                                data-name="${item.name}"
                                                data-price="${item.price}"
                                                data-description="${item.description}"
                                                data-is-pizza="${item.isPizza}">
                                            Adicionar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        sectionEl.insertAdjacentHTML('beforeend', itemHtml);
                    }
                });

                // Reanexa os event listeners após popular o cardápio
                attachAddButtonListeners();
            }

            // Listener para fechar o modal de seleção de pizza
            closePizzaOptionModalBtn.addEventListener('click', function() {
                pizzaOptionModal.style.display = 'none';
            });

            // Fecha o modal se clicar fora do conteúdo do modal
            window.addEventListener('click', function(event) {
                if (event.target == pizzaOptionModal) {
                    pizzaOptionModal.style.display = 'none';
                }
            });
            
            // Função para adicionar um item ao array de pedidos
            function addToOrder(item) {
                order.push(item); // Adiciona o item ao array
                updateOrderDisplay(); // Atualiza a exibição do carrinho
                
                // Feedback visual de adição
                const feedback = document.createElement('div');
                feedback.textContent = '✔️ Adicionado ao pedido!';
                feedback.className = 'fixed right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg slide-in';
                feedback.style.zIndex = '100'; // Garante que esteja acima de outros elementos

                // Calcula a posição logo acima do botão "Ver Pedido"
                // Garante que o botão "Ver Pedido" esteja visível para obter sua altura
                // Temporariamente mostra o botão para pegar a altura correta
                const wasHidden = viewOrderMobileBtn.classList.contains('hidden');
                if (wasHidden) {
                    viewOrderMobileBtn.classList.remove('hidden');
                }
                const viewOrderBtnHeight = viewOrderMobileBtn.offsetHeight;
                const bottomPosition = viewOrderBtnHeight + 16; // 16px para o espaçamento bottom-4 do botão
                feedback.style.bottom = `${bottomPosition}px`;

                document.body.appendChild(feedback);
                
                // Restaura o estado de visibilidade original do botão "Ver Pedido"
                if (wasHidden) {
                    viewOrderMobileBtn.classList.add('hidden');
                }

                // Remove o feedback após 2 segundos
                setTimeout(() => {
                    feedback.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                    setTimeout(() => feedback.remove(), 300);
                }, 2000);
            }
            
            // Função para atualizar a exibição do carrinho e os totais
            function updateOrderDisplay() {
                if (order.length === 0) {
                    orderItemsEl.innerHTML = '<p class="text-gray-500 text-center py-4">Seu pedido está vazio</p>';
                    viewOrderMobileBtn.classList.add('hidden'); // Oculta o botão "Ver Pedido"
                } else {
                    orderItemsEl.innerHTML = ''; // Limpa a lista de itens
                    
                    order.forEach((item, index) => {
                        const itemEl = document.createElement('div');
                        // Ajusta a classe com base no tipo de item para distinção visual
                        itemEl.className = `flex justify-between items-start py-3 border-b ${item.type === 'half_pending' ? 'bg-yellow-50 border-yellow-300' : ''}`;
                        
                        let displayName = item.name;
                        if (item.selected_slices) { // Para pizzas, adiciona o tamanho em negrito no início
                            const sizeLabel = `${item.selected_slices} FATIAS`.toUpperCase();
                            displayName = `<b>${sizeLabel}</b>: ${item.name}`;
                        }

                        // Cria o HTML para cada item do pedido
                        itemEl.innerHTML = `
                            <div class="flex-1">
                                <h4 class="font-medium">${displayName}</h4>
                                <p class="text-sm text-gray-600">${item.description}</p>
                            </div>
                            <div class="flex items-center">
                                <span class="font-bold mr-4">R$ ${item.price.toFixed(2).replace('.', ',')}</span>
                                ${item.type !== 'half_pending' ? `<button class="remove-item-btn text-red-500 hover:text-red-700" data-index="${index}">
                                    <i class="fas fa-times"></i>
                                </button>` : ''}
                            </div>
                        `;
                        
                        orderItemsEl.appendChild(itemEl); // Adiciona o item à lista
                    });
                    // Oculta o botão "Ver Pedido" se a seção do pedido já estiver visível
                    // Isso será tratado pelo orderSectionObserver
                    // viewOrderMobileBtn.classList.remove('hidden'); 
                }
                
                // Calcula e atualiza os totais
                // Garante que a soma é feita sobre o preço de cada item no pedido
                const subtotal = order.reduce((sum, item) => sum + item.price, 0);
                const total = subtotal + currentDeliveryFee; // Usa a taxa de entrega atual
                
                subtotalEl.textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
                deliveryFeeEl.textContent = `R$ ${currentDeliveryFee.toFixed(2).replace('.', ',')}`; // Atualiza a exibição da taxa
                totalEl.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;

                // Reavalia a visibilidade do botão "Ver Pedido" após a atualização do pedido
                // para garantir que o IntersectionObserver seja acionado.
                if (orderSectionContainer) {
                    orderSectionObserver.unobserve(orderSectionContainer);
                    orderSectionObserver.observe(orderSectionContainer);
                }
            }
            
            // Remove item do pedido quando o botão de remover é clicado
            orderItemsEl.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-item-btn') || e.target.closest('.remove-item-btn')) {
                    const btn = e.target.classList.contains('remove-item-btn') ? e.target : e.target.closest('.remove-item-btn');
                    const index = parseInt(btn.dataset.index); // Pega o índice do item a ser removido
                    
                    order.splice(index, 1); // Remove o item do array
                    updateOrderDisplay(); // Atualiza a exibição
                }
            });
            
            // Botão Finalizar Pedido
            document.getElementById('checkout-btn').addEventListener('click', checkAndSuggestDrinks);

            // Listener para o botão "Continuar sem bebidas" do modal de sugestão
            proceedWithoutDrinksBtn.addEventListener('click', () => {
                drinkSuggestionModal.style.display = 'none';
                sendOrderToWhatsapp(); // Envia para o WhatsApp mesmo sem bebidas
            });

            // Listener para fechar o modal de sugestão de bebidas
            closeDrinkSuggestionModalBtn.addEventListener('click', () => {
                drinkSuggestionModal.style.display = 'none';
            });

            // Fecha o modal de sugestão de bebidas se clicar fora
            window.addEventListener('click', function(event) {
                if (event.target == drinkSuggestionModal) {
                    drinkSuggestionModal.style.display = 'none';
                }
            });

            // Listener para o botão "Ver Pedido" mobile
            viewOrderMobileBtn.addEventListener('click', function() {
                // Rola para o topo da seção do pedido
                const orderSection = document.querySelector('.lg\\:w-1\\/3');
                if (orderSection) {
                    orderSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });

            // Chamada inicial para popular o cardápio e definir a categoria ativa correta no carregamento
            window.addEventListener('load', () => {
                populateMenu(); // Popula o cardápio dinamicamente
                // Dispara um evento de rolagem após um curto atraso para garantir que o observer seja executado
                // depois que todos os elementos forem renderizados e posicionados corretamente.
                setTimeout(() => {
                    window.dispatchEvent(new Event('scroll'));
                }, 100);
            });
        });
    </script>
</body>
</html>
