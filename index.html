<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sâmia - Cardápio Online</title>
    <!-- Inclui a biblioteca Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inclui a biblioteca Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon: Define o logótipo como ícone da aba do navegador -->
    <link rel="icon" href="https://raw.githubusercontent.com/WillianSoares93/catalogo_pizzaria/refs/heads/main/logo.png" type="image/png">
    
    <!-- Adicionado para PWA: Link para o arquivo de manifesto -->
    <!-- OBS: O Service Worker é a principal causa do cache agressivo de arquivos estáticos. A linha abaixo não causa problemas se o service-worker.js não existir. Se você precisar do PWA, pode registrá-lo manualmente, mas ele pode reintroduzir o problema de cache da página. -->
    <link rel="manifest" href="/manifest.json">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f4e9; /* Cor de fundo suave */
        }
        
        /* Estilos para os cartões de sabor (pizza/bebida) */
        .flavor-card {
            transition: all 0.3s ease;
        }
        .flavor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        /* Estilos para os botões de pedido */
        .btn-order {
            /* Mantido o gradiente laranja para vermelho para um toque vibrante */
            background: linear-gradient(135deg, #f59e0b, #ef4444); 
            transition: all 0.3s ease;
        }
        .btn-order:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }
        
        /* Estilo para o botão "Adicionar mais" (mantido em tom amarelo/laranja para contraste) */
        .btn-add-more {
            background: linear-gradient(135deg, #fbbf24, #fcd34d); 
            transition: all 0.3s ease;
        }
        .btn-add-more:hover {
            transform: scale(1.02);
            box-shadow: 0 3px 10px rgba(251, 191, 36, 0.4);
        }

        /* Estilo para o cabeçalho com imagem de fundo (overlay vermelho já presente) */
        .header-bg {
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://invexo.com.br/blog/wp-content/uploads/2022/12/pizza-pizzaria-gavea-rio-de-janeiro.jpg');
            background-size: cover;
            background-position: center;
        }

        /* Estilos para o modal principal (usado para seleção de pizza) */
        .modal {
            display: none; /* Oculto por padrão */
            position: fixed; /* Posição fixa na tela */
            z-index: 1000; /* Acima de outros elementos */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Habilita rolagem se o conteúdo for muito grande */
            background-color: rgba(0,0,0,0.4); /* Fundo escuro semitransparente */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: fadeIn 0.3s ease-out;
            border: 2px solid #ef4444; /* Borda vermelha */
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { transform: translateY(0); }
        }

        /* Estilos para o modal de mensagem */
        .message-modal {
            display: none; /* Oculto por padrão */
            position: fixed; /* Posição fixa na tela */
            z-index: 1001; /* Acima de outros elementos */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Habilita rolagem se o conteúdo for muito grande */
            background-color: rgba(0,0,0,0.4); /* Fundo escuro semitransparente */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .message-modal-content {
            background-color: #fefefe; /* Revertido para cor neutra */
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }

        /* Estilos para o popup de promoção */
        .promotion-popup {
            display: none; /* Oculto por padrão */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .promotion-popup-content {
            background-color: #fff;
            padding: 40px;
            border-radius: 15px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            animation: popIn 0.4s ease-out;
            border: 3px solid #dc2626; /* Borda vermelha para promoções */
            overflow-y: auto;
            max-height: 90vh;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .promotion-popup-content h3 {
            font-size: 2.25rem;
            font-weight: bold;
            color: #dc2626;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .promotion-popup-content p {
            font-size: 1.125rem;
            color: #374151;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .promotion-popup-content .close-button {
            top: 15px;
            right: 25px;
            font-size: 32px;
            color: #6b7280;
        }

        .promotion-popup-content .close-button:hover {
            color: #1f2937;
        }

        .promotion-item {
            background-color: #fee2e2; /* Fundo vermelho claro para itens de promoção */
            border: 1px solid #ef4444; /* Borda vermelha */
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            text-align: left;
        }

        .promotion-item h4 {
            font-weight: bold;
            color: #dc2626; /* Título vermelho */
            margin-bottom: 5px;
        }

        .promotion-item p {
            font-size: 0.95rem;
            color: #4b5563;
            margin-bottom: 5px;
        }

        .promotion-item .price {
            font-weight: bold;
            color: #dc2626; /* Preço vermelho */
            font-size: 1.1rem;
        }

        /* Estilos para o botão flutuante de promoção */
        #promotion-button {
            display: none; /* Oculto por padrão, será exibido via JS */
            position: fixed;
            bottom: 20px;
            left: 20px; /* Posição à esquerda */
            background-color: #dc2626; /* Vermelho vibrante */
            color: white;
            padding: 15px 20px;
            border-radius: 50px; /* Formato de pílula */
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            cursor: pointer;
            z-index: 1500; /* Acima da maioria dos elementos, mas abaixo dos modais */
            transition: background-color 0.3s ease;
            animation: pulse 1.5s infinite; /* Animação de piscar */
            align-items: center;
            gap: 8px;
        }

        #promotion-button:hover {
            background-color: #b91c1c; /* Vermelho mais escuro no hover */
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } /* Usando rgba do red-600 */
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        /* Estilos para os desenhos de pizza no modal de seleção */
        .pizza-size-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px; /* Reduzido o padding */
            background-color: #f9fafb; /* Fundo cinza claro */
            border: 2px solid #e5e7eb; /* gray-200 */
            border-radius: 10px; /* Mais arredondado */
            cursor: pointer;
            transition: all 0.3s ease-in-out; /* Transição mais suave */
            text-align: center;
            flex-shrink: 0; /* Prevents items from shrinking */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); /* Sombra sutil */
        }
        .pizza-size-option:hover {
            border-color: #dc2626; /* red-600 */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); /* Sombra mais intensa no hover */
            transform: translateY(-4px); /* Efeito de elevação maior */
        }
        .pizza-size-option .font-bold.text-lg {
            font-size: 1rem;
            color: #1f2937;
        }
        .pizza-size-option .text-red-600.font-bold {
            font-size: 1.125rem;
            color: #dc2626;
        }
        .pizza-size-option button {
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .pizza-size-option img {
            margin-bottom: 8px;
            width: 100px;
            height: 70px;
            object-fit: contain;
        }
        
        /* Custom styles for sticky category bar on mobile */
        @media (max-width: 1023px) { /* Applies to screens smaller than 'lg' breakpoint */
            .category-bar-mobile-sticky {
                position: sticky;
                top: 0;
                z-index: 10;
                background-color: #f9fafb; /* bg-gray-50 */
                padding-top: 1rem; /* pt-4 */
                padding-bottom: 0.5rem; /* pb-2 */
                box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* subtle shadow */
            }
        }

        /* Adicionado para ajustar a rolagem para as seções, considerando a barra fixa */
        .pizza-category-section {
            scroll-margin-top: 6rem; /* Ajuste este valor se a altura da barra fixa mudar */
        }

        /* Estilos para os itens de bebida sugeridos no modal */
        .suggested-drink-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f0fdf4; /* green-50 */
            border: 1px solid #dcfce7; /* green-100 */
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .suggested-drink-item .drink-name {
            font-weight: 600;
            color: #16a34a; /* green-600 */
        }
        .suggested-drink-item .drink-price {
            font-weight: 700;
            color: #15803d; /* green-700 */
        }
        .suggested-drink-item button {
            background-color: #22c55e; /* green-500 */
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .suggested-drink-item button:hover {
            background-color: #16a34a; /* green-600 */
        }

        /* CSS para a animação do item voando para o carrinho */
        .fly-to-cart-animation {
            position: fixed;
            background-color: #ef4444; /* Red-500 */
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            z-index: 9999; /* Acima de tudo */
            pointer-events: none; /* Não interfere com cliques */
            animation: flyToCart 0.8s ease-in-out forwards;
            opacity: 1;
            overflow: hidden; /* Garante que a imagem não saia do círculo */
        }

        .fly-to-cart-animation img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Garante que a imagem preencha o círculo */
        }

        @keyframes flyToCart {
            0% {
                left: var(--start-x);
                top: var(--start-y);
                transform: scale(1);
                opacity: 1;
            }
            70% {
                transform: scale(1.2);
                opacity: 0.8;
            }
            100% {
                left: var(--end-x);
                top: var(--end-y);
                transform: scale(0);
                opacity: 0;
            }
        }

        /* Estilos para as opções de pagamento no modal */
        .payment-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .payment-option:hover {
            background-color: #f9fafb; /* gray-50 */
            border-color: #dc2626; /* red-600 */
        }
        .payment-option.selected {
            background-color: #fee2e2; /* red-100 */
            border-color: #dc2626; /* red-600 */
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);
        }
        .payment-option input[type="radio"] {
            margin-right: 12px;
            accent-color: #dc2626; /* red-600 */
        }
        .payment-option .icon {
            font-size: 1.5rem;
            margin-right: 12px;
            color: #4b5563; /* gray-600 */
        }
        .payment-option.selected .icon {
            color: #dc2626; /* red-600 */
        }
        .payment-option .text-content {
            flex-grow: 1;
        }
        .payment-option .text-content h4 {
            font-weight: 600;
            color: #1f2937; /* gray-900 */
        }
        .payment-option .text-content p {
            font-size: 0.875rem;
            color: #6b7280; /* gray-500 */
        }

        /* Estilos para o botão dinâmico de checkout no modal de sugestão de bebidas */
        .dynamic-checkout-button.green-gradient {
            background: linear-gradient(135deg, #22c55e, #10b981); /* green-500 to green-600 */
        }
        .dynamic-checkout-button.green-gradient:hover {
            background: linear-gradient(135deg, #10b981, #059669); /* darker green on hover */
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.4);
        }

        /* Estilos para o modal de endereço */
        .address-modal {
            display: none; /* Oculto por padrão */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .address-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: fadeIn 0.3s ease-out;
            border: 2px solid #ef4444;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-[9999] hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-red-600 mb-4"></div>
        <p class="text-gray-800 text-lg font-semibold">Carregando Cardápio...</p>
    </div>

    <!-- Header -->
    <header class="header-bg text-white py-16 px-4 text-center">
        <div class="max-w-4xl mx-auto">
            <!-- Logotipo da Sâmia -->
            <img src="https://raw.githubusercontent.com/WillianSoares93/catalogo_pizzaria/refs/heads/main/logo.png" alt="Logotipo Sâmia" class="h-64 mx-auto mb-4 object-contain">
            <p class="text-2xl mb-8">Pizzaria Artesanal</p>
            <div class="flex justify-center space-x-4">
                <a href="#menu" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full transition duration-300">
                    Ver Cardápio
                </a>
            </div>
        </div>
    </header>

    <!-- Menu Section -->
    <section id="menu" class="py-8 px-4 max-w-6xl mx-auto">
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold text-gray-800 mb-4">Nosso Cardápio</h2>
            <p class="text-gray-600 text-lg mx-auto">Escolha sua pizza favorita ou uma bebida refrescante!</p>
        </div>

        <!-- Mensagem "Arrasta para o lado" para mobile -->
        <div class="text-gray-500 text-sm text-center mb-4 lg:hidden">
            <i class="fas fa-hand-point-right mr-1"></i> Arraste para o lado para ver outras opções
        </div>

        <!-- Sticky Category Buttons Container -->
        <div class="category-bar-mobile-sticky lg:static lg:p-0">
            <!-- Os botões de categoria serão gerados dinamicamente aqui pelo JS -->
            <div id="category-buttons-container" class="flex space-x-2 mb-6 overflow-x-auto pb-2 
                        lg:flex-row lg:space-x-2 lg:mb-6 lg:overflow-visible lg:pb-0">
            </div>
        </div>
        
        <!-- Lista de Itens do Cardápio -->
        <div id="pizza-list">
            <!-- As seções de categoria e seus itens serão geradas dinamicamente aqui pelo JS -->
            <div id="dynamic-pizza-sections"></div>
        </div>
    </section>

    <!-- Order Summary Sidebar -->
    <div id="orderSidebar" class="fixed top-0 right-0 h-full w-full bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Seu Pedido</h3>
                <button onclick="closeOrderSidebar()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="orderItems" class="mb-6">
                <!-- Itens do pedido serão adicionados dinamicamente -->
                <p class="text-gray-500 text-center py-8" id="emptyOrderMessage">Seu pedido está vazio</p>
            </div>
            
            <div class="border-t border-gray-200 pt-4 mb-6">
                <div class="flex justify-between mb-2">
                    <span class="text-gray-600">Subtotal:</span>
                    <span id="subtotal" class="font-bold">R$ 0,00</span>
                </div>
                <!-- Seção de taxa de entrega dinâmica -->
                <div id="deliveryFeeSection" class="flex justify-between mb-2">
                    <span class="text-gray-600">Taxa de entrega:</span>
                    <div id="deliveryFeeContainer" class="flex items-center">
                        <span id="deliveryFeeDisplay" class="font-bold"></span>
                        <button id="informAddressBtn" class="ml-2 px-3 py-1 bg-red-600 text-white rounded-md text-sm hover:bg-red-700 transition hidden">
                            Informar Endereço
                        </button>
                        <button id="editDeliveryAddressBtn" class="ml-2 text-blue-500 hover:text-blue-700 text-sm hidden">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-between text-lg font-bold">
                    <span>Total:</span>
                    <span id="total" class="text-red-600">R$ 0,00</span>
                </div>
            </div>

            <!-- Seção de Resumo do Endereço -->
            <div id="address-summary-section" class="border border-gray-200 rounded-lg p-4 mb-6 bg-gray-50 hidden">
                <h4 class="font-bold text-gray-800 mb-2">Endereço de Entrega:</h4>
                <p id="address-display" class="text-gray-700 text-sm"></p>
                <p id="neighborhood-display" class="text-gray-600 text-sm"></p>
                <p id="reference-display" class="text-gray-600 text-sm italic"></p>
                <button id="editAddressBtn" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600 transition">Editar</button>
            </div>

            <button id="checkoutButton" class="bg-green-600 text-white w-full py-3 rounded-full font-bold text-lg mt-auto hover:bg-green-700 transition duration-300">
                Finalizar Pedido
            </button>
            
        </div>
    </div>

    <!-- Carrinho Flutuante (Floating Cart Button) -->
    <button id="floating-cart-button" class="fixed bottom-4 right-4 bg-red-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl z-40 transition-transform duration-300 transform scale-100 hover:scale-110">
        <i class="fas fa-shopping-cart"></i>
        <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-500 rounded-full">0</span>
    </button>
    
    <!-- Botão Flutuante de Promoções -->
    <button id="promotion-button" class="flex items-center fixed bottom-20 left-4 bg-red-600 text-white px-5 py-3 rounded-full font-bold shadow-lg transition-transform duration-300 transform scale-100 hover:scale-110 z-30" style="display: none;">
        <i class="fas fa-bullhorn mr-2 text-xl"></i>
        Promoções
    </button>

    <!-- Modal para Seleção de Pizza -->
    <div id="pizzaModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closePizzaModal()">&times;</span>
            <h3 id="pizzaModalTitle" class="text-2xl font-bold mb-4 text-gray-800">Escolha o Tamanho da Pizza</h3>
            <div id="pizzaModalContent">
                <!-- Opções de tamanho, sabores, etc, serão populadas aqui pelo JS -->
            </div>
            <button id="addPizzaButton" class="btn-order w-full mt-6 py-3 rounded-full font-bold text-lg">
                Adicionar ao Carrinho
            </button>
        </div>
    </div>
    
    <!-- Modal para Seleção de Bebida (Sugestões) -->
    <div id="drinkSuggestionModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeDrinkSuggestionModal()">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Adicionar uma bebida?</h3>
            <div id="drinkSuggestionsContainer" class="max-h-[300px] overflow-y-auto pr-2">
                <!-- Bebidas sugeridas serão populadas aqui -->
            </div>
            <div class="flex justify-between items-center mt-6">
                <button onclick="closeDrinkSuggestionModal()" class="btn-add-more text-gray-800 px-6 py-3 rounded-full font-bold">
                    Não, obrigado
                </button>
                <button id="checkoutWithDrinkButton" class="btn-order bg-green-600 text-white px-6 py-3 rounded-full font-bold">
                    Ir para o Checkout
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Endereço -->
    <div id="addressModal" class="address-modal">
        <div class="address-modal-content">
            <span class="close-button" onclick="closeAddressModal()">&times;</span>
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Informar Endereço</h3>
            <form id="addressForm" onsubmit="handleAddressForm(event)">
                <div class="mb-4">
                    <label for="deliveryFeeNeighborhood" class="block text-sm font-medium text-gray-700">Bairro</label>
                    <select id="deliveryFeeNeighborhood" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm" required>
                        <option value="">Selecione o seu bairro...</option>
                        <!-- Opções populadas pelo JS -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="addressStreet" class="block text-sm font-medium text-gray-700">Rua e Número</label>
                    <input type="text" id="addressStreet" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm" placeholder="Ex: Rua da Paz, 123" required>
                </div>
                <div class="mb-4">
                    <label for="addressReference" class="block text-sm font-medium text-gray-700">Ponto de Referência (Opcional)</label>
                    <input type="text" id="addressReference" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm" placeholder="Ex: Ao lado da igreja">
                </div>
                <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-red-700 transition duration-300">
                    Confirmar Endereço
                </button>
            </form>
        </div>
    </div>
    
    <!-- Modal de Promoções -->
    <div id="promotion-popup" class="promotion-popup">
        <div class="promotion-popup-content">
            <span class="close-button" onclick="closePromotionPopup()">&times;</span>
            <h3>Promoções Ativas</h3>
            <div id="promotion-items-container" class="max-h-80 overflow-y-auto mt-4 pr-2">
                <!-- Promoções serão injetadas aqui pelo JS -->
            </div>
            <button onclick="closePromotionPopup()" class="mt-6 bg-red-600 text-white font-bold py-2 px-6 rounded-full transition duration-300 hover:bg-red-700">
                Fechar
            </button>
        </div>
    </div>

    <!-- Modal de Mensagem de Erro/Informação -->
    <div id="messageModal" class="message-modal">
        <div class="message-modal-content">
            <p id="messageText" class="text-gray-800 text-lg mb-4"></p>
            <button onclick="closeMessageModal()" class="px-6 py-2 bg-red-600 text-white rounded-md font-semibold">OK</button>
        </div>
    </div>

    <script>
        // Variáveis globais para o estado da aplicação
        let allMenuData = [];
        let allPromotionsData = [];
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let deliveryFeesData = [];
        let selectedPizza = null;
        let selectedPizzaOptions = {
            size: null,
            flavor1: null,
            flavor2: null,
            price: 0
        };
        let addressInfo = JSON.parse(localStorage.getItem('addressInfo')) || null;
        let selectedPaymentMethod = null;
        let hasDrinks = false; // Flag para verificar se há bebidas no modal de pizza
        let hasPromotions = false; // Flag para verificar se há promoções
        
        // Constantes para chaves do localStorage e tempo de cache
        const LOCAL_STORAGE_MENU_KEY = 'cachedMenu';
        const LOCAL_STORAGE_PROMOTIONS_KEY = 'cachedPromotions';
        const LOCAL_STORAGE_DELIVERY_FEES_KEY = 'cachedDeliveryFees';
        const LOCAL_STORAGE_LAST_FETCH_TIMESTAMP_KEY = 'lastFetchTimestamp';
        const CACHE_STALE_TIME = 1000 * 60 * 5; // Tempo de vida do cache dos dados: 5 minutos

        // Variável 'now' definida no escopo global
        const now = new Date().getTime();

        // Funções de Utilitário
        function formatCurrency(value) {
            return `R$ ${parseFloat(value).toFixed(2).replace('.', ',')}`;
        }

        function slugify(text) {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-') // Substitui espaços por hífens
                .replace(/[^\w-]+/g, '') // Remove caracteres não alfanuméricos
                .replace(/--+/g, '-') // Substitui múltiplos hífens por um único
                .replace(/^-+/, '') // Remove hífens do início
                .replace(/-+$/, ''); // Remove hífens do fim
        }
        
        // Funções de manipulação de CSV e dados
        function parseCsvData(csvText, type) {
            if (!csvText) {
                console.warn(`DEBUG: parseCsvData para ${type} - CSV Vazio ou Inválido.`);
                return [];
            }

            console.log(`DEBUG: parseCsvData para ${type} - CSV Bruto (primeiras 100 chars):`, csvText.substring(0, 100));
            const [rawHeaders, ...rows] = csvText.trim().split('\n').map(row => row.split(',').map(cell => cell.trim()));

            console.log(`DEBUG: parseCsvData para ${type} - Headers Brutos:`, rawHeaders);
            
            const headerMap = {
                'cardapio': {
                    'id item (unico)': 'id',
                    'nome do item': 'name',
                    'descricao': 'description',
                    'preco 8 fatias': 'basePrice',
                    'preco 6 fatias': 'price6Slices',
                    'preco 4 fatias': 'price4Slices',
                    'categoria': 'category',
                    'e pizza? (sim/nao)': 'isPizza',
                    'disponivel (sim/nao)': 'available',
                    'imagem': 'imageUrl'
                },
                'promocoes': {
                    'id promocao': 'id',
                    'nome da promocao': 'name',
                    'descricao': 'description',
                    'preco promocional': 'promoPrice',
                    'id item aplicavel': 'itemId',
                    'ativo (sim/nao)': 'active'
                },
                'deliveryFees': {
                    'bairros': 'neighborhood',
                    'valor frete': 'deliveryFee'
                }
            };

            console.log(`DEBUG: parseCsvData para ${type} - Conteúdo do headerMap:`, headerMap);

            const headers = rawHeaders.map(h => {
                const cleanedHeader = h.toLowerCase().replace(/"/g, '').trim();
                console.log(`DEBUG: Processando header "${h}" para tipo ${type}. Cleaned: "${cleanedHeader}"`);
                return headerMap[type][cleanedHeader] || cleanedHeader; // Mapeia o header para uma chave mais amigável
            });

            console.log(`DEBUG: parseCsvData para ${type} - Headers Mapeados:`, headers);

            const data = rows.map(row => {
                const item = {};
                headers.forEach((header, index) => {
                    let value = row[index] ? row[index].replace(/"/g, '') : '';
                    if (type === 'cardapio' || type === 'promocoes') {
                        if (header === 'isPizza' || header === 'available' || header === 'active') {
                            item[header] = value.toUpperCase() === 'SIM';
                            console.log(`DEBUG: Item ${item.name} - ${header}: ${item[header]} (raw value: "${value}")`);
                        } else if (header.startsWith('price') || header === 'promoPrice') {
                            // Trata preços no formato "99,99"
                            item[header] = parseFloat(value.replace(',', '.')) || null;
                        } else {
                            item[header] = value;
                        }
                    } else if (type === 'deliveryFees') {
                        if (header === 'deliveryFee') {
                            item[header] = parseFloat(value.replace(',', '.'));
                        } else {
                            item[header] = value;
                        }
                    }
                });
                return item;
            }).filter(item => Object.keys(item).length > 0);
            
            console.log(`DEBUG: Dados parseados para ${type}:`, data.length, data);
            return data;
        }

        function createCategoryButtons(categories) {
            const container = document.getElementById('category-buttons-container');
            container.innerHTML = '';
            categories.forEach(category => {
                const button = document.createElement('button');
                const categorySlug = slugify(category);
                button.className = 'category-button flex-shrink-0 bg-red-100 text-red-600 font-semibold py-2 px-4 rounded-full transition-colors duration-300 hover:bg-red-200';
                button.innerText = category;
                button.onclick = () => {
                    const targetSection = document.getElementById(`category-${categorySlug}`);
                    if (targetSection) {
                        targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };
                container.appendChild(button);
            });
        }

        function populateMenu(menuData, orderedCategories) {
            const container = document.getElementById('dynamic-pizza-sections');
            container.innerHTML = '';

            console.log("DEBUG: populateMenu chamado. Recebeu dados:", menuData.length > 0);

            orderedCategories.forEach(category => {
                const categoryItems = menuData.filter(item => item.category === category && item.available);
                if (categoryItems.length > 0) {
                    const categorySlug = slugify(category);
                    const section = document.createElement('div');
                    section.id = `category-${categorySlug}`;
                    section.className = 'pizza-category-section mb-10';

                    const title = document.createElement('h3');
                    title.className = 'text-3xl font-bold text-gray-800 mb-6 border-b-4 border-red-600 pb-2 inline-block';
                    title.innerText = category;
                    section.appendChild(title);

                    const itemsGrid = document.createElement('div');
                    itemsGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                    
                    categoryItems.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'flavor-card bg-white rounded-xl shadow-lg overflow-hidden flex flex-col justify-between';
                        
                        let priceText = item.basePrice ? formatCurrency(item.basePrice) : 'Preço sob consulta';

                        if (item.isPizza && item.basePrice) {
                             priceText = formatCurrency(item.basePrice);
                        } else if (item.basePrice) {
                            priceText = formatCurrency(item.basePrice);
                        }
                        
                        // Verifica se o item tem uma promoção aplicada
                        const promotion = allPromotionsData.find(p => p.itemId === item.id && p.active);
                        const originalPriceText = priceText;
                        let promotionText = '';

                        if (promotion) {
                            priceText = formatCurrency(promotion.promoPrice);
                            promotionText = `<span class="text-gray-400 line-through mr-2">${originalPriceText}</span>`;
                        }
                        
                        card.innerHTML = `
                            <div class="p-6 flex-grow">
                                <h4 class="text-xl font-bold text-gray-800">${item.name}</h4>
                                <p class="text-gray-600 mt-2 text-sm">${item.description}</p>
                            </div>
                            <div class="p-6 bg-gray-50 flex items-center justify-between">
                                <div class="flex flex-col">
                                    <span class="text-gray-500 text-sm">Preço:</span>
                                    <div class="text-2xl font-bold text-red-600 mt-1">
                                        ${promotionText}${priceText}
                                    </div>
                                </div>
                                <button data-item-id="${item.id}" class="btn-order bg-gradient-to-r from-red-500 to-red-600 text-white font-bold py-2 px-6 rounded-full transition duration-300">
                                    Adicionar
                                </button>
                            </div>
                        `;
                        itemsGrid.appendChild(card);
                    });
                    section.appendChild(itemsGrid);
                    container.appendChild(section);
                }
            });

            // Adiciona event listeners aos botões de 'Adicionar'
            document.querySelectorAll('.btn-order').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const itemId = button.dataset.itemId;
                    const item = allMenuData.find(i => i.id === itemId);

                    if (item) {
                        if (item.isPizza) {
                            openPizzaModal(item);
                        } else {
                            addItemToCart(item, 1);
                        }
                    }
                });
            });
        }

        function populateNeighborhoodDropdown(feesData) {
            const dropdown = document.getElementById('deliveryFeeNeighborhood');
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="">Selecione o seu bairro...</option>';
            if (feesData && feesData.length > 0) {
                feesData.forEach(fee => {
                    const option = document.createElement('option');
                    option.value = fee.neighborhood;
                    option.dataset.fee = fee.deliveryFee;
                    option.textContent = `${fee.neighborhood} (${formatCurrency(fee.deliveryFee)})`;
                    dropdown.appendChild(option);
                });
            }
        }

        function updatePromotionButtonVisibility() {
            const promotionsButton = document.getElementById('promotion-button');
            if (allPromotionsData && allPromotionsData.length > 0 && allPromotionsData.some(p => p.active)) {
                promotionsButton.style.display = 'flex';
                hasPromotions = true;
            } else {
                promotionsButton.style.display = 'none';
                hasPromotions = false;
            }
        }

        function displayPromotionsPopup() {
            const promotionPopup = document.getElementById('promotion-popup');
            const promotionContent = document.getElementById('promotion-items-container');
            promotionContent.innerHTML = '';

            if (allPromotionsData.length === 0) {
                promotionContent.innerHTML = '<p class="text-center text-gray-500">Não há promoções ativas no momento.</p>';
            } else {
                allPromotionsData.forEach(promo => {
                    if (promo.active) {
                        const promotionItem = document.createElement('div');
                        promotionItem.className = 'promotion-item';
                        promotionItem.innerHTML = `
                            <h4 class="text-xl">${promo.name}</h4>
                            <p>${promo.description}</p>
                            <p class="price mt-2">Preço: ${formatCurrency(promo.promoPrice)}</p>
                        `;
                        promotionContent.appendChild(promotionItem);
                    }
                });
            }
            promotionPopup.style.display = 'flex';
        }

        function closePromotionPopup() {
            const promotionPopup = document.getElementById('promotion-popup');
            promotionPopup.style.display = 'none';
        }

        // Função principal de carregamento de dados
        async function fetchAndRenderMenu() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.classList.remove('hidden');

            try {
                const response = await fetch('/api/menu');
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('DEBUG: Erro HTTP ao buscar dados da API:', response.status, errorText);
                    throw new Error(`Erro ao buscar dados da API: ${response.statusText || errorText}`);
                }
                const data = await response.json();
                console.log('DEBUG: Dados da API recebidos com sucesso:', data);

                const cardapioCsvText = data.cardapio;
                const promocoesCsvText = data.promocoes;
                const deliveryFeesCsvText = data.deliveryFees;

                allMenuData = parseCsvData(cardapioCsvText, 'cardapio');
                allPromotionsData = parseCsvData(promocoesCsvText, 'promocoes');
                deliveryFeesData = parseCsvData(deliveryFeesCsvText, 'deliveryFees');
                
                // Salva os dados no localStorage após a busca bem-sucedida
                localStorage.setItem(LOCAL_STORAGE_MENU_KEY, JSON.stringify(allMenuData));
                localStorage.setItem(LOCAL_STORAGE_PROMOTIONS_KEY, JSON.stringify(allPromotionsData));
                localStorage.setItem(LOCAL_STORAGE_DELIVERY_FEES_KEY, JSON.stringify(deliveryFeesData));
                localStorage.setItem(LOCAL_STORAGE_LAST_FETCH_TIMESTAMP_KEY, now.toString());
                console.log('DEBUG: Novos dados da API salvos no localStorage e UI atualizada.');

                renderPage();

            } catch (error) {
                console.error('DEBUG: Erro fatal ao carregar o cardápio:', error);
                showMessageModal('Não foi possível carregar o cardápio no momento. Por favor, tente novamente mais tarde.');
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function renderPage() {
            // Obter categorias únicas e ordenadas
            const orderedUniqueCategories = [];
            const seenCategories = new Set();
            allMenuData.forEach(item => {
                if (!seenCategories.has(item.category)) {
                    seenCategories.add(item.category);
                    orderedUniqueCategories.push(item.category);
                }
            });

            // Popular a UI com os dados obtidos
            createCategoryButtons(orderedUniqueCategories);
            populateMenu(allMenuData, orderedUniqueCategories);
            populateNeighborhoodDropdown(deliveryFeesData);
            updatePromotionButtonVisibility();
            updateCartCount();
            updateOrderDisplay();
            updateCheckoutButtonText();
            showAddressSummary();
            setupCategoryObserver();
            toggleAddItemButtons(true);
            toggleCategoryButtons(true);
            setTimeout(() => { window.dispatchEvent(new Event('scroll')); }, 100);
            console.log('DEBUG: Carregamento completo e bem-sucedido.');
        }

        // Evento principal para carregar o conteúdo
        document.addEventListener('DOMContentLoaded', async function() {
            // OBS: O registro do Service Worker foi removido para evitar cache agressivo da página inteira.

            const lastFetchTimestamp = localStorage.getItem(LOCAL_STORAGE_LAST_FETCH_TIMESTAMP_KEY);
            const shouldFetchFromApi = !lastFetchTimestamp || (now - parseInt(lastFetchTimestamp, 10) > CACHE_STALE_TIME);

            if (shouldFetchFromApi) {
                console.log('DEBUG: O cache dos dados está obsoleto ou não existe. Buscando novos dados da API.');
                await fetchAndRenderMenu();
            } else {
                console.log('DEBUG: O cache dos dados ainda é válido (5 minutos). Carregando dados do localStorage.');
                const cachedMenuData = JSON.parse(localStorage.getItem(LOCAL_STORAGE_MENU_KEY));
                const cachedPromotionsData = JSON.parse(localStorage.getItem(LOCAL_STORAGE_PROMOTIONS_KEY));
                const cachedDeliveryFeesData = JSON.parse(localStorage.getItem(LOCAL_STORAGE_DELIVERY_FEES_KEY));

                if (cachedMenuData && cachedPromotionsData && cachedDeliveryFeesData) {
                    allMenuData = cachedMenuData;
                    allPromotionsData = cachedPromotionsData;
                    deliveryFeesData = cachedDeliveryFeesData;
                    renderPage();
                    document.getElementById('loading-overlay').classList.add('hidden');
                    console.log('DEBUG: Carregamento instantâneo do cache de dados concluído.');
                } else {
                    console.log('DEBUG: Cache de dados inválido ou incompleto. Forçando busca da API.');
                    await fetchAndRenderMenu();
                }
            }
        });

        // Funções adicionais do cardápio (carrinho, modais, etc.)
        
        // ... (restante do seu código, como openPizzaModal, addItemToCart, updateCartCount, etc.) ...

        const openPizzaModal = (item) => {
            selectedPizza = item;
            selectedPizzaOptions = {
                size: null,
                flavor1: null,
                flavor2: null,
                price: 0
            };
            const modal = document.getElementById('pizzaModal');
            const modalTitle = document.getElementById('pizzaModalTitle');
            const modalContent = document.getElementById('pizzaModalContent');
            const addPizzaButton = document.getElementById('addPizzaButton');
            
            modalTitle.innerText = `Escolha o tamanho da ${item.name}`;
            
            let htmlContent = `
                <div id="pizza-size-container" class="grid grid-cols-3 gap-4 mb-6">
                    <!-- Opções de tamanho serão injetadas aqui -->
                </div>
            `;
            modalContent.innerHTML = htmlContent;

            const sizeContainer = document.getElementById('pizza-size-container');
            const sizes = ['4Slices', '6Slices', '8Slices'];
            const sizeNames = ['Pequena (4 Fatias)', 'Média (6 Fatias)', 'Grande (8 Fatias)'];
            const sizeImages = ['https://placehold.co/100x70/ffe1b7/944000?text=4', 'https://placehold.co/100x70/ffe1b7/944000?text=6', 'https://placehold.co/100x70/ffe1b7/944000?text=8'];

            sizes.forEach((size, index) => {
                const price = item[`price${size}`] || item.basePrice;
                if (price) {
                    const option = document.createElement('div');
                    option.className = 'pizza-size-option';
                    option.setAttribute('data-size', size);
                    option.innerHTML = `
                        <img src="${sizeImages[index]}" alt="${sizeNames[index]}">
                        <span class="font-bold text-lg">${sizeNames[index]}</span>
                        <span class="text-red-600 font-bold">${formatCurrency(price)}</span>
                    `;
                    option.onclick = () => selectPizzaSize(size, price);
                    sizeContainer.appendChild(option);
                }
            });

            addPizzaButton.onclick = () => addSelectedPizzaToCart();
            modal.style.display = 'flex';
        };

        const selectPizzaSize = (size, price) => {
            document.querySelectorAll('#pizza-size-container .pizza-size-option').forEach(option => {
                option.classList.remove('selected');
            });
            const selectedOption = document.querySelector(`.pizza-size-option[data-size="${size}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            selectedPizzaOptions.size = size;
            selectedPizzaOptions.price = price;
            
            if (selectedPizzaOptions.flavor1 && selectedPizzaOptions.flavor2) {
                updateAddPizzaButton();
            }

            // Popula os sabores de pizza (se a pizza for de 2 sabores)
            if (selectedPizza.isPizza && selectedPizza.name === "Pizza Meio a Meio") {
                const pizzaFlavors = allMenuData.filter(item => item.isPizza && item.id !== "MEIOAMEIO" && item.available);
                const flavorsHtml = `
                    <h4 class="text-xl font-bold mt-6 mb-4 text-gray-800">Escolha o primeiro sabor:</h4>
                    <select id="flavor1-select" class="w-full p-2 border rounded mb-4" onchange="selectPizzaFlavor(1)">
                        <option value="">Selecione um sabor...</option>
                        ${pizzaFlavors.map(f => `<option value="${f.id}">${f.name} - ${formatCurrency(f.basePrice)}</option>`).join('')}
                    </select>
                    <h4 class="text-xl font-bold mb-4 text-gray-800">Escolha o segundo sabor:</h4>
                    <select id="flavor2-select" class="w-full p-2 border rounded mb-4" onchange="selectPizzaFlavor(2)">
                        <option value="">Selecione um sabor...</option>
                        ${pizzaFlavors.map(f => `<option value="${f.id}">${f.name} - ${formatCurrency(f.basePrice)}</option>`).join('')}
                    </select>
                `;
                document.getElementById('pizzaModalContent').innerHTML += flavorsHtml;
                updateAddPizzaButton();
            } else {
                updateAddPizzaButton();
            }
        };

        const selectPizzaFlavor = (flavorNumber) => {
            const select1 = document.getElementById('flavor1-select');
            const select2 = document.getElementById('flavor2-select');
            
            if (flavorNumber === 1) {
                selectedPizzaOptions.flavor1 = allMenuData.find(i => i.id === select1.value);
            } else if (flavorNumber === 2) {
                selectedPizzaOptions.flavor2 = allMenuData.find(i => i.id === select2.value);
            }

            if (selectedPizzaOptions.flavor1 && selectedPizzaOptions.flavor2) {
                updateAddPizzaButton();
            }
        };

        const updateAddPizzaButton = () => {
            const addPizzaButton = document.getElementById('addPizzaButton');
            if (selectedPizzaOptions.size) {
                if (selectedPizza.name === "Pizza Meio a Meio") {
                    if (selectedPizzaOptions.flavor1 && selectedPizzaOptions.flavor2) {
                        addPizzaButton.disabled = false;
                        addPizzaButton.classList.remove('bg-gray-400');
                        addPizzaButton.classList.add('bg-red-600', 'hover:bg-red-700');
                    } else {
                        addPizzaButton.disabled = true;
                        addPizzaButton.classList.add('bg-gray-400');
                        addPizzaButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                    }
                } else {
                    addPizzaButton.disabled = false;
                    addPizzaButton.classList.remove('bg-gray-400');
                    addPizzaButton.classList.add('bg-red-600', 'hover:bg-red-700');
                }
            } else {
                addPizzaButton.disabled = true;
                addPizzaButton.classList.add('bg-gray-400');
                addPizzaButton.classList.remove('bg-red-600', 'hover:bg-red-700');
            }
        };

        const addSelectedPizzaToCart = () => {
            if (!selectedPizzaOptions.size) {
                showMessageModal('Por favor, selecione um tamanho de pizza.');
                return;
            }
            if (selectedPizza.name === "Pizza Meio a Meio" && (!selectedPizzaOptions.flavor1 || !selectedPizzaOptions.flavor2)) {
                showMessageModal('Por favor, selecione dois sabores para a pizza.');
                return;
            }
            
            const pizzaPrice = selectedPizzaOptions.price;
            let itemToAdd = { ...selectedPizza, price: pizzaPrice, quantity: 1 };
            
            if (selectedPizza.name === "Pizza Meio a Meio") {
                const flavor1Name = selectedPizzaOptions.flavor1.name;
                const flavor2Name = selectedPizzaOptions.flavor2.name;
                itemToAdd.name = `Pizza ${selectedPizzaOptions.size} (${flavor1Name} & ${flavor2Name})`;
            } else {
                itemToAdd.name = `Pizza ${selectedPizzaOptions.size} (${selectedPizza.name})`;
            }

            addItemToCart(itemToAdd, 1);
            closePizzaModal();
        };

        const closePizzaModal = () => {
            document.getElementById('pizzaModal').style.display = 'none';
        };

        const openOrderSidebar = () => {
            document.getElementById('orderSidebar').classList.remove('translate-x-full');
            document.body.style.overflow = 'hidden';
            updateOrderDisplay();
        };

        const closeOrderSidebar = () => {
            document.getElementById('orderSidebar').classList.add('translate-x-full');
            document.body.style.overflow = '';
        };
        
        const openAddressModal = () => {
            const modal = document.getElementById('addressModal');
            modal.style.display = 'flex';
        };

        const closeAddressModal = () => {
            const modal = document.getElementById('addressModal');
            modal.style.display = 'none';
        };

        const handleAddressForm = (e) => {
            e.preventDefault();
            const neighborhoodDropdown = document.getElementById('deliveryFeeNeighborhood');
            const neighborhood = neighborhoodDropdown.value;
            const street = document.getElementById('addressStreet').value;
            const reference = document.getElementById('addressReference').value;
            const selectedOption = neighborhoodDropdown.options[neighborhoodDropdown.selectedIndex];
            const deliveryFee = parseFloat(selectedOption.dataset.fee);

            addressInfo = { neighborhood, street, reference, deliveryFee };
            localStorage.setItem('addressInfo', JSON.stringify(addressInfo));

            updateOrderDisplay();
            showAddressSummary();
            closeAddressModal();
        };

        const showAddressSummary = () => {
            const summarySection = document.getElementById('address-summary-section');
            const informAddressBtn = document.getElementById('informAddressBtn');
            const editDeliveryAddressBtn = document.getElementById('editDeliveryAddressBtn');
            
            if (addressInfo) {
                document.getElementById('address-display').innerText = `Rua: ${addressInfo.street}`;
                document.getElementById('neighborhood-display').innerText = `Bairro: ${addressInfo.neighborhood}`;
                document.getElementById('reference-display').innerText = `Ponto de Referência: ${addressInfo.reference || 'N/A'}`;
                summarySection.classList.remove('hidden');
                informAddressBtn.classList.add('hidden');
                editDeliveryAddressBtn.classList.remove('hidden');
                document.getElementById('editAddressBtn').onclick = openAddressModal;
                editDeliveryAddressBtn.onclick = openAddressModal;
            } else {
                summarySection.classList.add('hidden');
                informAddressBtn.classList.remove('hidden');
                editDeliveryAddressBtn.classList.add('hidden');
                informAddressBtn.onclick = openAddressModal;
            }
        };

        const calculateSubtotal = () => {
            let subtotal = cart.reduce((total, item) => {
                let price = item.price;
                const promotion = allPromotionsData.find(p => p.itemId === item.id && p.active);
                if (promotion) {
                    price = promotion.promoPrice;
                }
                return total + (price * item.quantity);
            }, 0);
            return subtotal;
        };

        const calculateTotal = () => {
            const subtotal = calculateSubtotal();
            const deliveryFee = addressInfo ? addressInfo.deliveryFee : 0;
            return subtotal + deliveryFee;
        };

        const updateOrderDisplay = () => {
            const orderItemsContainer = document.getElementById('orderItems');
            orderItemsContainer.innerHTML = '';
            
            if (cart.length === 0) {
                document.getElementById('emptyOrderMessage').style.display = 'block';
                document.getElementById('checkoutButton').disabled = true;
                document.getElementById('checkoutButton').classList.add('bg-gray-400', 'cursor-not-allowed');
                document.getElementById('checkoutButton').classList.remove('bg-green-600', 'hover:bg-green-700');
            } else {
                document.getElementById('emptyOrderMessage').style.display = 'none';
                document.getElementById('checkoutButton').disabled = false;
                document.getElementById('checkoutButton').classList.remove('bg-gray-400', 'cursor-not-allowed');
                document.getElementById('checkoutButton').classList.add('bg-green-600', 'hover:bg-green-700');

                cart.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex items-center justify-between mb-4 border-b pb-2';
                    
                    const price = allPromotionsData.find(p => p.itemId === item.id && p.active) ? 
                                    allPromotionsData.find(p => p.itemId === item.id && p.active).promoPrice : 
                                    item.price;

                    itemElement.innerHTML = `
                        <div class="flex items-center">
                            <span class="bg-gray-200 text-gray-800 rounded-full h-8 w-8 flex items-center justify-center font-bold text-sm mr-4">${item.quantity}</span>
                            <div class="flex flex-col">
                                <span class="font-semibold text-gray-800">${item.name}</span>
                                <span class="text-sm text-gray-600">${formatCurrency(price)} cada</span>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="font-bold text-red-600 mr-4">${formatCurrency(price * item.quantity)}</span>
                            <button onclick="removeItemFromCart(${index})" class="text-red-500 hover:text-red-700 text-xl transition-colors duration-200">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    orderItemsContainer.appendChild(itemElement);
                });
            }
            
            document.getElementById('subtotal').innerText = formatCurrency(calculateSubtotal());
            document.getElementById('total').innerText = formatCurrency(calculateTotal());

            const deliveryFeeDisplay = document.getElementById('deliveryFeeDisplay');
            const informAddressBtn = document.getElementById('informAddressBtn');
            const editDeliveryAddressBtn = document.getElementById('editDeliveryAddressBtn');
            
            if (addressInfo) {
                deliveryFeeDisplay.innerText = formatCurrency(addressInfo.deliveryFee);
                deliveryFeeDisplay.classList.remove('hidden');
                informAddressBtn.classList.add('hidden');
                editDeliveryAddressBtn.classList.remove('hidden');
            } else {
                deliveryFeeDisplay.innerText = '';
                deliveryFeeDisplay.classList.add('hidden');
                informAddressBtn.classList.remove('hidden');
                editDeliveryAddressBtn.classList.add('hidden');
            }
        };

        const updateCartCount = () => {
            const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
            const cartCountElement = document.getElementById('cart-count');
            cartCountElement.innerText = totalItems;
            if (totalItems > 0) {
                cartCountElement.classList.remove('hidden');
            } else {
                cartCountElement.classList.add('hidden');
            }
        };

        const addItemToCart = (item, quantity) => {
            const existingItem = cart.find(cartItem => cartItem.name === item.name);

            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({ ...item, quantity });
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            updateOrderDisplay();
            animateToCart();
        };
        
        const removeItemFromCart = (index) => {
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            updateOrderDisplay();
        };

        const updateCheckoutButtonText = () => {
            const checkoutButton = document.getElementById('checkoutButton');
            const subtotal = calculateSubtotal();
            
            if (subtotal > 0) {
                checkoutButton.innerHTML = `Finalizar Pedido (${formatCurrency(subtotal)})`;
            } else {
                checkoutButton.innerHTML = 'Finalizar Pedido';
            }
        };

        const animateToCart = () => {
            const floatingCart = document.getElementById('floating-cart-button');
            const flyingItem = document.createElement('div');
            flyingItem.className = 'fly-to-cart-animation';
            
            // Posição inicial (centro da tela)
            flyingItem.style.setProperty('--start-x', `${window.innerWidth / 2 - 15}px`);
            flyingItem.style.setProperty('--start-y', `${window.innerHeight / 2 - 15}px`);

            // Posição final (carrinho flutuante)
            const cartRect = floatingCart.getBoundingClientRect();
            flyingItem.style.setProperty('--end-x', `${cartRect.left + cartRect.width / 2 - 15}px`);
            flyingItem.style.setProperty('--end-y', `${cartRect.top + cartRect.height / 2 - 15}px`);

            document.body.appendChild(flyingItem);

            flyingItem.addEventListener('animationend', () => {
                flyingItem.remove();
            });
        };

        const setupCategoryObserver = () => {
            const sections = document.querySelectorAll('.pizza-category-section');
            const buttons = document.querySelectorAll('.category-button');

            const observerOptions = {
                root: null,
                rootMargin: '0px 0px -70% 0px', // Ativa quando a seção está 30% acima do topo da tela
                threshold: 0
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const sectionId = entry.target.id;
                        const categoryName = sectionId.replace('category-', '');
                        
                        buttons.forEach(button => {
                            if (slugify(button.innerText) === categoryName) {
                                button.classList.remove('bg-red-100', 'text-red-600');
                                button.classList.add('bg-red-600', 'text-white');
                            } else {
                                button.classList.add('bg-red-100', 'text-red-600');
                                button.classList.remove('bg-red-600', 'text-white');
                            }
                        });
                    }
                });
            }, observerOptions);

            sections.forEach(section => {
                observer.observe(section);
            });
        };

        // ... Funções para modals e outros ...
        const showMessageModal = (message) => {
            document.getElementById('messageText').innerText = message;
            document.getElementById('messageModal').style.display = 'flex';
        };

        const closeMessageModal = () => {
            document.getElementById('messageModal').style.display = 'none';
        };

        const handleCheckout = () => {
            if (!addressInfo) {
                showMessageModal('Por favor, informe seu endereço de entrega antes de finalizar o pedido.');
                return;
            }

            let cartString = cart.map(item => {
                const promotion = allPromotionsData.find(p => p.itemId === item.id && p.active);
                const price = promotion ? promotion.promoPrice : item.price;
                return `${item.quantity}x ${item.name} (${formatCurrency(price * item.quantity)})`;
            }).join('\n');

            const subtotal = calculateSubtotal();
            const deliveryFee = addressInfo ? addressInfo.deliveryFee : 0;
            const total = subtotal + deliveryFee;

            const message = `*Pedido Online - Sâmia Pizzaria*%0A%0A
*Itens do Pedido:*%0A
${cartString}%0A%0A
*Resumo do Pedido:*%0A
Subtotal: ${formatCurrency(subtotal)}%0A
Taxa de Entrega: ${formatCurrency(deliveryFee)}%0A
*Total: ${formatCurrency(total)}*%0A%0A
*Endereço de Entrega:*%0A
Bairro: ${addressInfo.neighborhood}%0A
Rua e Número: ${addressInfo.street}%0A
Ponto de Referência: ${addressInfo.reference || 'N/A'}%0A%0A
*Método de Pagamento:*%0A
${selectedPaymentMethod || 'Não selecionado'}%0A%0A
Obrigado pelo seu pedido!`;
            
            const whatsappUrl = `https://wa.me/5567998246386?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        };

        const openPaymentModal = () => {
            // Placeholder para abrir o modal de pagamento, se necessário
            // Para este exemplo, a lógica de checkout direto para o WhatsApp foi mantida.
            handleCheckout();
        };

        // Event Listeners
        document.getElementById('floating-cart-button').addEventListener('click', openOrderSidebar);
        document.getElementById('checkoutButton').addEventListener('click', openPaymentModal);
        document.getElementById('promotion-button').addEventListener('click', displayPromotionsPopup);

        // ... Final do script
    </script>
</body>
</html>
