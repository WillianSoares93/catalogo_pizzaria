<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sua Pizzaria - Cardápio Online</title>
    <!-- Inclui a biblioteca Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inclui a biblioteca Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f4e9; /* Cor de fundo suave */
        }
        
        /* Estilos para os cartões de sabor (pizza/bebida) */
        .flavor-card {
            transition: all 0.3s ease;
        }
        .flavor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        /* Estilos para os botões de pedido */
        .btn-order {
            /* Mantido o gradiente laranja para vermelho para um toque vibrante */
            background: linear-gradient(135deg, #f59e0b, #ef4444); 
            transition: all 0.3s ease;
        }
        .btn-order:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }
        
        /* Estilo para o botão "Adicionar mais" (mantido em tom amarelo/laranja para contraste) */
        .btn-add-more {
            background: linear-gradient(135deg, #fbbf24, #fcd34d); 
            transition: all 0.3s ease;
        }
        .btn-add-more:hover {
            transform: scale(1.02);
            box-shadow: 0 3px 10px rgba(251, 191, 36, 0.4);
        }

        /* Estilo para o cabeçalho com imagem de fundo (overlay vermelho já presente) */
        .header-bg {
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://invexo.com.br/blog/wp-content/uploads/2022/12/pizza-pizzaria-gavea-rio-de-janeiro.jpg');
            background-size: cover;
            background-position: center;
        }

        /* Estilos para o modal principal (usado para seleção de pizza) */
        .modal {
            display: none; /* Oculto por padrão */
            position: fixed; /* Posição fixa na tela */
            z-index: 1000; /* Acima de outros elementos */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Habilita rolagem se o conteúdo for muito grande */
            background-color: rgba(0,0,0,0.4); /* Fundo escuro semitransparente */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: fadeIn 0.3s ease-out;
            border: 2px solid #ef4444; /* Borda vermelha */
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { transform: translateY(0); }
        }

        /* Estilos para o modal de mensagem */
        .message-modal {
            display: none; /* Oculto por padrão */
            position: fixed; /* Posição fixa na tela */
            z-index: 1001; /* Acima de outros elementos */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Habilita rolagem se o conteúdo for muito grande */
            background-color: rgba(0,0,0,0.4); /* Fundo escuro semitransparente */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .message-modal-content {
            background-color: #fefefe; /* Revertido para cor neutra */
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }

        /* Estilos para o popup de promoção */
        .promotion-popup {
            display: none; /* Oculto por padrão */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .promotion-popup-content {
            background-color: #fff;
            padding: 40px;
            border-radius: 15px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            animation: popIn 0.4s ease-out;
            border: 3px solid #dc2626; /* Borda vermelha para promoções */
            overflow-y: auto;
            max-height: 90vh;
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .promotion-popup-content h3 {
            font-size: 2.25rem;
            font-weight: bold;
            color: #dc2626;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .promotion-popup-content p {
            font-size: 1.125rem;
            color: #374151;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .promotion-popup-content .close-button {
            top: 15px;
            right: 25px;
            font-size: 32px;
            color: #6b7280;
        }

        .promotion-popup-content .close-button:hover {
            color: #1f2937;
        }

        .promotion-item {
            background-color: #fee2e2; /* Fundo vermelho claro para itens de promoção */
            border: 1px solid #ef4444; /* Borda vermelha */
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            text-align: left;
        }

        .promotion-item h4 {
            font-weight: bold;
            color: #dc2626; /* Título vermelho */
            margin-bottom: 5px;
        }

        .promotion-item p {
            font-size: 0.95rem;
            color: #4b5563;
            margin-bottom: 5px;
        }

        .promotion-item .price {
            font-weight: bold;
            color: #dc2626; /* Preço vermelho */
            font-size: 1.1rem;
        }

        /* Estilos para o botão flutuante de promoção */
        #promotion-button {
            display: none; /* Oculto por padrão, será exibido via JS */
            position: fixed;
            bottom: 20px;
            left: 20px; /* Posição à esquerda */
            background-color: #dc2626; /* Vermelho vibrante */
            color: white;
            padding: 15px 20px;
            border-radius: 50px; /* Formato de pílula */
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            cursor: pointer;
            z-index: 1500; /* Acima da maioria dos elementos, mas abaixo dos modais */
            transition: background-color 0.3s ease;
            animation: pulse 1.5s infinite; /* Animação de piscar */
            align-items: center;
            gap: 8px;
        }

        #promotion-button:hover {
            background-color: #b91c1c; /* Vermelho mais escuro no hover */
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } /* Usando rgba do red-600 */
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        /* Estilos para os desenhos de pizza no modal de seleção */
        .pizza-size-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px; /* Reduzido o padding */
            background-color: #f9fafb; /* Fundo cinza claro */
            border: 2px solid #e5e7eb; /* gray-200 */
            border-radius: 10px; /* Mais arredondado */
            cursor: pointer;
            transition: all 0.3s ease-in-out; /* Transição mais suave */
            text-align: center;
            flex-shrink: 0; /* Prevents items from shrinking */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08); /* Sombra sutil */
        }
        .pizza-size-option:hover {
            border-color: #dc2626; /* red-600 */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); /* Sombra mais intensa no hover */
            transform: translateY(-4px); /* Efeito de elevação maior */
        }
        .pizza-size-option img {
            margin-bottom: 8px;
            width: 100px;
            height: 70px;
            object-fit: contain;
        }
        .pizza-size-option .font-bold.text-lg {
            font-size: 1rem;
            color: #1f2937;
        }
        .pizza-size-option .text-red-600.font-bold {
            font-size: 1.125rem;
            color: #dc2626;
        }
        .pizza-size-option button {
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        /* Custom styles for sticky category bar on mobile */
        @media (max-width: 1023px) { /* Applies to screens smaller than 'lg' breakpoint */
            .category-bar-mobile-sticky {
                position: sticky;
                top: 0;
                z-index: 10;
                background-color: #f9fafb; /* bg-gray-50 */
                padding-top: 1rem; /* pt-4 */
                padding-bottom: 0.5rem; /* pb-2 */
                box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* subtle shadow */
            }
        }

        /* Adicionado para ajustar a rolagem para as seções, considerando a barra fixa */
        .pizza-category-section {
            scroll-margin-top: 6rem; /* Ajuste este valor se a altura da barra fixa mudar */
        }

        /* Estilos para os itens de bebida sugeridos no modal */
        .suggested-drink-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f0fdf4; /* green-50 */
            border: 1px solid #dcfce7; /* green-100 */
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .suggested-drink-item .drink-name {
            font-weight: 600;
            color: #16a34a; /* green-600 */
        }
        .suggested-drink-item .drink-price {
            font-weight: 700;
            color: #15803d; /* green-700 */
        }
        .suggested-drink-item button {
            background-color: #22c55e; /* green-500 */
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .suggested-drink-item button:hover {
            background-color: #16a34a; /* green-600 */
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header-bg text-white py-16 px-4 text-center">
        <div class="max-w-4xl mx-auto">
            <!-- Logotipo da Sua Pizzaria -->
            <img src="https://i.imgur.com/HQiEKNy.png" alt="Logotipo Sua Pizzaria" class="h-64 mx-auto mb-4 object-contain">
            <p class="text-2xl mb-8">Pizzaria Artesanal</p>
            <div class="flex justify-center space-x-4">
                <a href="#menu" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full transition duration-300">
                    Ver Cardápio
                </a>
            </div>
        </div>
    </header>

    <!-- Menu Section -->
    <section id="menu" class="py-8 px-4 max-w-6xl mx-auto">
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold text-gray-800 mb-4">Nosso Cardápio</h2>
            <p class="text-gray-600 text-lg mx-auto">Escolha sua pizza favorita ou uma bebida refrescante!</p>
        </div>

        <!-- Mensagem "Arrasta para o lado" para mobile -->
        <div class="text-gray-500 text-sm text-center mb-4 lg:hidden">
            <i class="fas fa-hand-point-right mr-1"></i> Arraste para o lado para ver outras opções
        </div>

        <!-- Sticky Category Buttons Container -->
        <div class="category-bar-mobile-sticky lg:static lg:p-0">
            <div class="flex space-x-2 mb-6 overflow-x-auto pb-2 
                        lg:flex-row lg:space-x-2 lg:mb-6 lg:overflow-visible lg:pb-0">
                <button class="category-btn px-4 py-2 rounded-full bg-red-600 text-white whitespace-nowrap lg:flex-grow-0 lg:flex-shrink-0" data-category="tradicionais" data-target-id="tradicionais-section">Pizzas Tradicionais</button>
                <button class="category-btn px-4 py-2 rounded-full bg-gray-200 text-gray-800 whitespace-nowrap lg:flex-grow-0 lg:flex-shrink-0" data-category="especiais" data-target-id="especiais-section">Pizzas Especiais</button>
                <button class="category-btn px-4 py-2 rounded-full bg-gray-200 text-gray-800 whitespace-nowrap lg:flex-grow-0 lg:flex-shrink-0" data-category="doces" data-target-id="doces-section">Pizzas Doces</button>
                <button class="category-btn px-4 py-2 rounded-full bg-gray-200 text-gray-800 whitespace-nowrap lg:flex-grow-0 lg:flex-shrink-0" data-category="bebidas" data-target-id="bebidas-section">Bebidas</button>
            </div>
        </div>
        
        <!-- Lista de Itens do Cardápio -->
        <div id="pizza-list">
            <div id="tradicionais-section" class="pizza-category-section mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Pizzas Tradicionais</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="tradicionais-items"></div>
            </div>
            
            <div id="especiais-section" class="pizza-category-section mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Pizzas Especiais</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="especiais-items"></div>
            </div>
            
            <div id="doces-section" class="pizza-category-section mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Pizzas Doces</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="doces-items"></div>
            </div>
            
            <div id="bebidas-section" class="pizza-category-section mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Bebidas</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="bebidas-items"></div>
            </div>
        </div>
    </section>

    <!-- Order Summary Sidebar -->
    <div id="orderSidebar" class="fixed top-0 right-0 h-full w-full bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300 overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Seu Pedido</h3>
                <button onclick="closeOrderSidebar()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="orderItems" class="mb-6">
                <!-- Itens do pedido serão adicionados dinamicamente -->
                <p class="text-gray-500 text-center py-8" id="emptyOrderMessage">Seu pedido está vazio</p>
            </div>
            
            <div class="border-t border-gray-200 pt-4 mb-6">
                <div class="flex justify-between mb-2">
                    <span class="text-gray-600">Subtotal:</span>
                    <span id="subtotal" class="font-bold">R$ 0,00</span>
                </div>
                <div class="flex justify-between mb-2">
                    <span class="text-gray-600">Taxa de entrega:</span>
                    <span id="deliveryFee" class="font-bold">R$ 5,00</span>
                </div>
                <div class="flex justify-between text-lg font-bold">
                    <span>Total:</span>
                    <span id="total">R$ 5,00</span>
                </div>
            </div>
            
            <!-- Botão "Adicionar mais" -->
            <button onclick="backToMenu()" class="btn-add-more w-full py-3 text-white font-bold rounded-full mb-4">
                Adicionar mais
            </button>

            <button onclick="checkout()" class="btn-order w-full py-3 text-white font-bold rounded-full mb-4">
                Finalizar Pedido
            </button>
            
            <!-- Botão "Limpar Pedido" -->
            <button onclick="clearOrder()" class="w-full py-2 bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-300">
                Limpar Pedido
            </button>
        </div>
    </div>

    <!-- Modal de Seleção de Pizza (Inteira/Meia) -->
    <div id="pizza-option-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-pizza-option-modal">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="modal-pizza-name"></h3>
            <p class="text-gray-600 mb-6" id="modal-pizza-description"></p>
            <div id="pizza-size-options" class="grid grid-cols-1 sm:grid-cols-3 gap-2 justify-items-center">
                <!-- Opções de tamanho e "meia a meia" serão inseridas aqui pelo JS -->
            </div>
        </div>
    </div>

    <!-- Modal de Mensagem (para feedback do usuário) -->
    <div id="message-modal" class="message-modal">
        <div class="modal-content">
            <span class="close-button" id="close-message-modal">&times;</span>
            <p class="text-lg font-semibold text-gray-800 mb-4" id="message-modal-text"></p>
            <button id="ok-message-modal" class="px-4 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">OK</button>
        </div>
    </div>

    <!-- Novo Modal de Promoção Flutuante -->
    <div id="promotion-popup" class="promotion-popup">
        <div class="promotion-popup-content">
            <span class="close-button" id="close-promotion-popup">&times;</span>
            <h3>Promoções Especiais!</h3>
            <p>Confira as nossas ofertas exclusivas e não perca tempo!</p>
            <div id="promotions-list">
                <!-- Promoções serão carregadas aqui -->
            </div>
            <button id="close-promotion-popup-btn" class="px-6 py-3 mt-6 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition w-full">
                Fechar Promoções
            </button>
        </div>
    </div>

    <!-- Novo Botão Flutuante de Promoção -->
    <button id="promotion-button" class="hidden">
        <i class="fas fa-tags text-xl"></i>
        <span>Promoções!</span>
    </button>

    <!-- Floating Order Button -->
    <div class="fixed bottom-6 right-6 z-40">
        <button onclick="toggleOrderSidebar()" class="bg-red-600 hover:bg-red-700 text-white rounded-full p-5 shadow-lg relative transition duration-300 transform hover:scale-110">
            <i class="fas fa-shopping-cart text-2xl"></i>
            <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-sm font-bold rounded-full h-7 w-7 flex items-center justify-center hidden">0</span>
        </button>
    </div>

    <!-- Modal de Sugestão de Bebidas -->
    <div id="drink-suggestion-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-drink-suggestion-modal">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Que tal adicionar uma bebida?</h3>
            <p class="text-gray-600 mb-6">Seu pedido não contém bebidas. Gostaria de adicionar alguma?</p>
            <div id="suggested-drinks-list" class="flex flex-col gap-3 mb-6">
                <!-- Sugestões de bebidas serão inseridas aqui via JS -->
            </div>
            <button id="proceed-without-drinks" class="px-6 py-3 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600 transition w-full">
                Continuar sem bebidas
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 px-4">
        <div class="max-w-6xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center md:text-left">
                <div>
                    <h3 class="text-xl font-bold mb-4">Sua Pizzaria</h3>
                    <p class="text-gray-400">As melhores pizzas artesanais da cidade, feitas com ingredientes frescos e muito carinho.</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Horário de Funcionamento</h3>
                    <p class="text-gray-400">Segunda a Sábado: 18:00 - 23:00</p>
                    <p class="text-gray-400">Domingo: 17:00 - 22:00</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Contato</h3>
                    <p class="text-gray-400"><i class="fas fa-phone mr-2"></i> (85) 98765-4321</p>
                    <p class="text-gray-400"><i class="fas fa-envelope mr-2"></i> contato@suapizzaria.com</p>
                    <div class="flex justify-center md:justify-start space-x-4 mt-2">
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-instagram text-xl"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-facebook text-xl"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i class="fab fa-whatsapp text-xl"></i></a>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                <p>&copy; 2023 Sua Pizzaria. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
        // URLs das planilhas Google Sheets publicadas como CSV
        const CARDAPIO_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQJeo2AAETdXC08x9EQlkIG1FiVLEosMng4IvaQYJAdZnIDHJw8CT8J5RAJNtJ5GWHOKHkUsd5V8OSL/pub?gid=664943668&single=true&output=csv';
        const PROMOCOES_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQJeo2AAETdXC08x9EQlkIG1FiVLEosMng4IvaQYJAdZnIDHJw8CT8J5RAJNtJ5GWHOKHkUsd5V8OSL/pub?gid=600393470&single=true&output=csv'; 

        // Variáveis globais
        let order = [];
        let allMenuData = []; // Armazenará todos os itens do cardápio (pizzas e bebidas)
        let allPromotionsData = [];

        // Referências para os elementos DOM
        const orderSidebar = document.getElementById('orderSidebar');
        const cartCount = document.getElementById('cartCount');
        const emptyOrderMessage = document.getElementById('emptyOrderMessage');
        const messageModal = document.getElementById('message-modal');
        const closeMessageModalBtn = document.getElementById('close-message-modal');
        const okMessageModalBtn = document.getElementById('ok-message-modal');
        const messageModalText = document.getElementById('message-modal-text');
        const promotionPopup = document.getElementById('promotion-popup');
        const closePromotionPopupBtn = document.getElementById('close-promotion-popup');
        const closePromotionPopupBtnBottom = document.getElementById('close-promotion-popup-btn');
        const promotionsListEl = document.getElementById('promotions-list');
        const promotionButton = document.getElementById('promotion-button');
        const cuscuzListEl = document.getElementById('cuscuz-list'); // Este será o container principal para pizzas agora
        const bebidasListEl = document.getElementById('bebidas-items'); // Container para bebidas
        const subtotalEl = document.getElementById('subtotal');
        const deliveryFeeEl = document.getElementById('deliveryFee');
        const totalEl = document.getElementById('total');

        // Referências para o modal de seleção de pizza
        const pizzaOptionModal = document.getElementById('pizza-option-modal');
        const closePizzaOptionModalBtn = document.getElementById('close-pizza-option-modal');
        const modalPizzaName = document.getElementById('modal-pizza-name');
        const modalPizzaDescription = document.getElementById('modal-pizza-description');
        const pizzaSizeOptions = document.getElementById('pizza-size-options');

        // Referências para o novo modal de sugestão de bebidas
        const drinkSuggestionModal = document.getElementById('drink-suggestion-modal');
        const closeDrinkSuggestionModalBtn = document.getElementById('close-drink-suggestion-modal');
        const suggestedDrinksList = document.getElementById('suggested-drinks-list');
        const proceedWithoutDrinksBtn = document.getElementById('proceed-without-drinks');


        let currentPizzaData = {}; // Objeto para armazenar temporariamente os dados da pizza selecionada
        let firstHalfPizza = null; // Armazena os dados da primeira metade de uma pizza dividida
        let isSelectingSecondHalf = false; // Flag para indicar se o usuário está escolhendo a segunda metade

        // Define tamanhos e seus multiplicadores de preço em relação ao preço de 8 fatias
        const sizes = [
            { slices: 4, label: '4 Fatias', priceKey: 'price4Slices' },
            { slices: 6, label: '6 Fatias', priceKey: 'price6Slices' },
            { slices: 8, label: '8 Fatias', priceKey: 'basePrice' } // basePrice é o preço de 8 fatias
        ];

        // Taxa de entrega fixa
        const deliveryFee = 5.00; 
        const whatsappNumber = '5587996070638'; 

        // Funções de controle de modais e sidebar
        function toggleOrderSidebar() {
            orderSidebar.classList.toggle('translate-x-full');
            orderSidebar.classList.toggle('translate-x-0');
        }
        
        function closeOrderSidebar() {
            orderSidebar.classList.add('translate-x-full');
            orderSidebar.classList.remove('translate-x-0');
        }
        
        function showMessageModal(message) {
            console.log("showMessageModal called with message:", message); // Debug log
            messageModalText.textContent = message;
            messageModal.style.display = 'flex';
            console.log("messageModal display set to:", messageModal.style.display); // Debug log
            // Also check if the element is actually found
            if (!messageModal) {
                console.error("messageModal element not found!"); // Debug error
            }
            if (!messageModalText) {
                console.error("messageModalText element not found!"); // Debug error
            }
        }

        function hideMessageModal() {
            messageModal.style.display = 'none';
        }

        // Listeners para fechar o modal de mensagem
        closeMessageModalBtn.addEventListener('click', hideMessageModal);
        okMessageModalBtn.addEventListener('click', hideMessageModal);
        window.addEventListener('click', function(event) {
            if (event.target == messageModal) {
                hideMessageModal();
            }
        });

        // Listeners para fechar o modal de seleção de pizza
        closePizzaOptionModalBtn.addEventListener('click', function() {
            pizzaOptionModal.style.display = 'none';
        });

        // Fecha o modal se clicar fora do conteúdo do modal
        window.addEventListener('click', function(event) {
            if (event.target == pizzaOptionModal) {
                pizzaOptionModal.style.display = 'none';
            }
        });

        // Função para gerar a imagem de uma fatia de pizza (vazia, apenas para estrutura)
        function getGenericPizzaSliceImage() {
            return ''; // Retorna uma string vazia para remover a imagem
        }

        // Funções para carregar dados das planilhas
        async function loadMenuFromSheet() {
            try {
                const urlWithCacheBuster = `${CARDAPIO_CSV_URL}&_=${new Date().getTime()}`;
                const response = await fetch(urlWithCacheBuster);
                const csvText = await response.text();
                const lines = csvText.split('\n').filter(line => line.trim() !== '');

                if (lines.length === 0) {
                    console.warn("Nenhuma linha válida encontrada no CSV do Cardápio.");
                    return [];
                }

                function parseCsvLine(line) {
                    const values = [];
                    let inQuote = false;
                    let currentField = '';
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            if (inQuote && i + 1 < line.length && line[i + 1] === '"') {
                                currentField += '"';
                                i++;
                            } else {
                                inQuote = !inQuote;
                            }
                        } else if (char === ',' && !inQuote) {
                            values.push(currentField);
                            currentField = '';
                        } else {
                            currentField += char;
                        }
                    }
                    values.push(currentField);
                    return values.map(v => {
                        if (v === undefined || v === null) return '';
                        let processed = v;
                        if (processed.startsWith('"') && processed.endsWith('"')) {
                            processed = processed.substring(1, processed.length - 1);
                        }
                        return processed.replace(/""/g, '"').trim();
                    });
                }

                const headersRaw = parseCsvLine(lines[0]);
                const mappedHeaders = headersRaw.map(header => {
                    let cleanedHeader = header.trim();
                    switch (cleanedHeader) {
                        case 'ID Item (único)': return 'id';
                        case 'Nome do Item': return 'name';
                        case 'Descrição': return 'description';
                        case 'Preço 8 fatias': return 'basePrice';
                        case 'Preço 6 fatias': return 'price6Slices';
                        case 'Preço 4 fatias': return 'price4Slices';
                        case 'Categoria': return 'category';
                        case 'É Pizza? (SIM/NÃO)': return 'isPizza';
                        case 'Disponível (SIM/NÃO)': return 'available'; 
                        default: return cleanedHeader.replace(/[^a-zA-Z0-9]+(.)?/g, (match, chr) => chr ? chr.toUpperCase() : '').replace(/^./, (match) => match.toLowerCase());
                    }
                });
                
                const menuData = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    const rowValues = parseCsvLine(line);
                    if (rowValues.length === mappedHeaders.length) {
                        let item = {
                            id: '', name: '', description: '', basePrice: 0, price6Slices: 0, price4Slices: 0, category: '', isPizza: false, available: false
                        };
                        for (let j = 0; j < mappedHeaders.length; j++) {
                            let headerKey = mappedHeaders[j];
                            let value = rowValues[j];
                            if (headerKey === 'basePrice' || headerKey === 'price6Slices' || headerKey === 'price4Slices') {
                                const parsedValue = parseFloat(String(value).replace(',', '.'));
                                item[headerKey] = isNaN(parsedValue) ? 0 : parsedValue;
                            } else if (headerKey === 'isPizza') {
                                item[headerKey] = value.toUpperCase() === 'SIM';
                            } else if (headerKey === 'available') {
                                item[headerKey] = value.toUpperCase() === 'SIM';
                            } else {
                                item[headerKey] = value;
                            }
                        }
                        if (item.available) {
                            menuData.push(item);
                        }
                    } else {
                        console.warn(`Linha ${i + 1} ignorada ou malformada (Cardápio - esperado ${mappedHeaders.length} colunas, encontrado ${rowValues.length}): "${line}"`);
                    }
                }
                return menuData;

            } catch (error) {
                console.error('Erro ao carregar cardápio da planilha:', error);
                return [];
            }
        }

        async function loadPromotionsFromSheet() {
            try {
                const urlWithCacheBuster = `${PROMOCOES_CSV_URL}&_=${new Date().getTime()}`;
                const response = await fetch(urlWithCacheBuster);
                const csvText = await response.text();
                const lines = csvText.split('\n').filter(line => line.trim() !== '');

                if (lines.length === 0) {
                    console.warn("Nenhuma linha válida encontrada no CSV de Promoções.");
                    return [];
                }

                function parseCsvLine(line) {
                    const values = [];
                    let inQuote = false;
                    let currentField = '';
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            if (inQuote && i + 1 < line.length && line[i + 1] === '"') {
                                currentField += '"';
                                i++;
                            } else {
                                inQuote = !inQuote;
                            }
                        } else if (char === ',' && !inQuote) {
                            values.push(currentField);
                            currentField = '';
                        } else {
                            currentField += char;
                        }
                    }
                    values.push(currentField);
                    return values.map(v => {
                        if (v === undefined || v === null) return '';
                        let processed = v;
                        if (processed.startsWith('"') && processed.endsWith('"')) {
                            processed = processed.substring(1, processed.length - 1);
                        }
                        return processed.replace(/""/g, '"').trim();
                    });
                }

                const headersRaw = parseCsvLine(lines[0]);
                const mappedHeaders = headersRaw.map(header => {
                    let cleanedHeader = header.trim();
                    switch (cleanedHeader) {
                        case 'ID Promocao': return 'id';
                        case 'Nome da Promocao': return 'name';
                        case 'Descricao': return 'description';
                        case 'Preco Promocional': return 'promoPrice';
                        case 'ID Item Aplicavel': return 'itemId';
                        case 'Ativo (SIM/NAO)': return 'active';
                        default: return cleanedHeader.replace(/[^a-zA-Z0-9]+(.)?/g, (match, chr) => chr ? chr.toUpperCase() : '').replace(/^./, (match) => match.toLowerCase());
                    }
                });
                
                const promotionsData = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    const rowValues = parseCsvLine(line);
                    if (rowValues.length === mappedHeaders.length) {
                        let promo = {
                            id: '', name: '', description: '', promoPrice: null, itemId: '', active: false
                        };
                        for (let j = 0; j < mappedHeaders.length; j++) {
                            let headerKey = mappedHeaders[j];
                            let value = rowValues[j];
                            if (headerKey === 'promoPrice') {
                                const parsedValue = parseFloat(String(value).replace(',', '.'));
                                promo[headerKey] = isNaN(parsedValue) ? null : parsedValue;
                            } else if (headerKey === 'active') {
                                promo[headerKey] = value.toUpperCase() === 'SIM';
                            } else {
                                promo[headerKey] = value;
                            }
                        }
                        if (promo.active) {
                            promotionsData.push(promo);
                        }
                    } else {
                        console.warn(`Linha ${i + 1} ignorada ou malformada (Promoções - esperado ${mappedHeaders.length} colunas, encontrado ${rowValues.length}): "${line}"`);
                    }
                }
                return promotionsData;

            } catch (error) {
                console.error('Erro ao carregar promoções da planilha:', error);
                return [];
            }
        }

        // Função para popular o cardápio dinamicamente
        function populateMenu(menuItems) {
            // Limpa as seções existentes antes de preencher
            document.getElementById('tradicionais-items').innerHTML = '';
            document.getElementById('especiais-items').innerHTML = '';
            document.getElementById('doces-items').innerHTML = '';
            document.getElementById('bebidas-items').innerHTML = '';

            menuItems.forEach(item => {
                const sectionItemsEl = document.getElementById(`${item.category}-items`);
                if (sectionItemsEl && item.available) { // Garante que o item está disponível
                    let itemHtml = '';
                    if (item.isPizza) {
                        // Usa os preços diretamente das propriedades do item
                        const price4F = (item.price4Slices !== undefined && item.price4Slices !== null) ? item.price4Slices.toFixed(2).replace('.', ',') : '0,00';
                        const price6F = (item.price6Slices !== undefined && item.price6Slices !== null) ? item.price6Slices.toFixed(2).replace('.', ',') : '0,00';
                        const price8F = (item.basePrice !== undefined && item.basePrice !== null) ? item.basePrice.toFixed(2).replace('.', ',') : '0,00';
                        
                        itemHtml = `
                            <div class="flavor-card bg-white rounded-xl overflow-hidden shadow-lg transition duration-300">
                                <div class="p-6">
                                    <h3 class="text-xl font-bold text-gray-800 mb-2">${item.name}</h3>
                                    <p class="text-gray-600 text-sm mb-4">${item.description}</p>
                                    <div class="flex flex-col items-end text-right mb-4">
                                        <span class="font-bold text-red-600 whitespace-nowrap">4F: R$ ${price4F}</span>
                                        <span class="font-bold text-red-600 whitespace-nowrap">6F: R$ ${price6F}</span>
                                        <span class="font-bold text-red-600 whitespace-nowrap">8F: R$ ${price8F}</span>
                                    </div>
                                    <div class="flex justify-end mt-auto">
                                        <button class="add-item-btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full text-sm font-medium transition duration-300"
                                                data-item-id="${item.id}">
                                            Adicionar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else { // Para bebidas
                        itemHtml = `
                            <div class="flavor-card bg-white rounded-xl overflow-hidden shadow-lg transition duration-300">
                                <div class="p-6">
                                    <h3 class="text-xl font-bold text-gray-800 mb-2">${item.name}</h3>
                                    <p class="text-gray-600 text-sm mb-4">${item.description}</p>
                                    <div class="flex justify-between items-center">
                                        <span class="font-bold text-red-600 text-lg">R$ ${item.basePrice.toFixed(2).replace('.', ',')}</span>
                                        <button class="add-item-btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full text-sm font-medium transition duration-300"
                                                data-item-id="${item.id}">
                                            Adicionar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    sectionItemsEl.insertAdjacentHTML('beforeend', itemHtml);
                }
            });

            // Reanexa os event listeners após popular o cardápio
            attachAddButtonListeners();
        }

        // Função para anexar os event listeners aos botões "Adicionar"
        function attachAddButtonListeners() {
            document.querySelectorAll('.add-item-btn').forEach(button => {
                button.removeEventListener('click', handleAddButtonClick); // Evita duplicações
                button.addEventListener('click', handleAddButtonClick);
            });
        }

        // Função para lidar com o clique no botão "Adicionar" (para pizzas e bebidas)
        function handleAddButtonClick(e) {
            const itemId = e.target.dataset.itemId;
            const item = allMenuData.find(i => i.id === itemId);

            if (!item) {
                console.error('Item não encontrado:', itemId);
                return;
            }

            if (isSelectingSecondHalf) {
                if (!item.isPizza) {
                    showMessageModal('Por favor, escolha uma pizza para a segunda metade.');
                    return;
                }

                // Remove o item "pending-half-pizza" do pedido
                const pendingHalfIndex = order.findIndex(orderItem => orderItem.id === 'pending-half-pizza');
                if (pendingHalfIndex > -1) {
                    order.splice(pendingHalfIndex, 1);
                }

                const cleanFirstName = firstHalfPizza.name;
                const combinedName = `Meia ${cleanFirstName} & Meia ${item.name}`;
                
                // Obtém o preço da primeira metade com base nas fatias selecionadas
                const priceFirstHalfFullSize = firstHalfPizza.original_full_price; 
                // Obtém o preço da segunda metade com base nas fatias selecionadas (mesmo tamanho da primeira metade)
                const priceSecondHalfFullSize = item[firstHalfPizza.priceKeyForSlices]; 

                // Garante que os valores são números antes da operação
                const combinedPrice = ((priceFirstHalfFullSize || 0) / 2) + ((priceSecondHalfFullSize || 0) / 2);
                const combinedDescription = `${firstHalfPizza.description.replace('Primeira metade: ', '')} e ${item.description}`;

                addToOrder({
                    type: 'split',
                    name: combinedName,
                    price: combinedPrice,
                    description: combinedDescription,
                    category: 'pizzas', // Categoria genérica para pizzas meio a meio
                    selected_slices: firstHalfPizza.selected_slices
                });

                firstHalfPizza = null;
                isSelectingSecondHalf = false;
                showTemporaryFeedback('Pizza meio a meio adicionada ao pedido!', 'bg-green-500'); // Usar feedback temporário
                
            } else if (item.isPizza) {
                currentPizzaData = { ...item }; // Copia o objeto item completo
                modalPizzaName.textContent = item.name;
                modalPizzaDescription.textContent = item.description;

                pizzaSizeOptions.innerHTML = '';
                
                sizes.forEach(size => {
                    const sizePrice = currentPizzaData[size.priceKey]; // Usa a chave de preço direta
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'pizza-size-option';
                    optionDiv.innerHTML = `
                        ${getGenericPizzaSliceImage()}
                        <span class="font-bold text-base text-gray-800">${size.label}</span>
                        <span class="text-red-600 font-bold text-lg">R$ ${sizePrice.toFixed(2).replace('.', ',')}</span>
                        <div class="flex flex-col gap-2 mt-2 w-full">
                            <button class="add-full-size-pizza-btn px-4 py-2 bg-red-600 text-white rounded-md text-sm hover:bg-red-700 transition"
                                    data-slices="${size.slices}" data-price-key="${size.priceKey}">
                                Adicionar Inteira
                            </button>
                            <button class="add-half-size-pizza-btn px-4 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 transition"
                                    data-slices="${size.slices}" data-price-key="${size.priceKey}">
                                Adicionar Meia Pizza
                            </button>
                        </div>
                    `;
                    pizzaSizeOptions.appendChild(optionDiv);

                    optionDiv.querySelector('.add-full-size-pizza-btn').addEventListener('click', function() {
                        const selectedSlices = parseInt(this.dataset.slices);
                        const selectedPriceKey = this.dataset.priceKey;
                        addToOrder({
                            type: 'full',
                            name: currentPizzaData.name,
                            price: currentPizzaData[selectedPriceKey], // Usa o preço direto da chave
                            description: currentPizzaData.description,
                            category: currentPizzaData.category,
                            selected_slices: selectedSlices
                        });
                        pizzaOptionModal.style.display = 'none';
                    });

                    optionDiv.querySelector('.add-half-size-pizza-btn').addEventListener('click', function() {
                        const selectedSlices = parseInt(this.dataset.slices);
                        const selectedPriceKey = this.dataset.priceKey;
                        firstHalfPizza = {
                            name: currentPizzaData.name,
                            price: currentPizzaData[selectedPriceKey] / 2, // Preço da metade
                            description: currentPizzaData.description,
                            original_full_price: currentPizzaData[selectedPriceKey], // Preço total da primeira metade
                            selected_slices: selectedSlices,
                            priceKeyForSlices: selectedPriceKey, // Armazena a chave de preço para a segunda metade
                            category: currentPizzaData.category
                        };
                        isSelectingSecondHalf = true;
                        pizzaOptionModal.style.display = 'none';
                        // Adiciona a meia pizza pendente ao pedido IMEDIATAMENTE
                        addToOrderOnly(
                            {
                                type: 'half_pending',
                                name: `½ ${currentPizzaData.name}`,
                                price: currentPizzaData[selectedPriceKey] / 2,
                                description: `Primeira metade: ${currentPizzaData.description}`,
                                id: 'pending-half-pizza',
                                category: currentPizzaData.category,
                                selected_slices: selectedSlices
                            }
                        );
                        // Pequeno atraso antes de mostrar o modal para garantir que a sidebar atualize
                        setTimeout(() => {
                            showMessageModal('Agora, escolha a segunda metade da sua pizza.'); 
                        }, 100);
                    });
                });

                pizzaOptionModal.style.display = 'flex';
            } else { // Para itens não-pizza (bebidas)
                addToOrder({
                    type: 'full',
                    name: item.name,
                    price: item.basePrice, // Para bebidas, basePrice é o preço único
                    description: item.description,
                    category: item.category
                });
            }
        }
        
        // Adicionar item ao array de pedidos (com abertura da sidebar e feedback)
        function addToOrder(item) {
            order.push(item);
            updateOrderDisplay();
            updateCartCount();
            toggleOrderSidebar(); // Abre a sidebar
            // Feedback visual de adição
            showTemporaryFeedback('✔️ Adicionado ao pedido!', 'bg-green-500');
        }

        // Adicionar item ao array de pedidos (SEM abertura da sidebar e SEM feedback)
        function addToOrderOnly(item) {
            order.push(item);
            updateOrderDisplay();
            updateCartCount();
            // Não chama toggleOrderSidebar() aqui
            // Não mostra showTemporaryFeedback() aqui
        }

        // Função genérica para exibir feedback temporário
        function showTemporaryFeedback(message, bgColorClass) {
            const feedback = document.createElement('div');
            feedback.textContent = message;
            feedback.className = `fixed right-4 ${bgColorClass} text-white px-4 py-2 rounded-lg shadow-lg slide-in`;
            feedback.style.zIndex = '100';

            const cartButton = document.querySelector('.fixed.bottom-6.right-6 button'); // Seleciona o botão do carrinho
            const cartButtonRect = cartButton.getBoundingClientRect();
            feedback.style.bottom = `${window.innerHeight - cartButtonRect.top + 10}px`; // Posição acima do botão do carrinho
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => feedback.remove(), 300);
            }, 2000);
        }
        
        // Atualizar exibição do pedido
        function updateOrderDisplay() {
            const orderItemsContainer = document.getElementById('orderItems');
            
            if (order.length === 0) {
                emptyOrderMessage.classList.remove('hidden');
                orderItemsContainer.innerHTML = '';
                orderItemsContainer.appendChild(emptyOrderMessage);
                
                document.getElementById('subtotal').textContent = 'R$ 0,00';
                document.getElementById('total').textContent = 'R$ ' + deliveryFee.toFixed(2).replace('.', ',');
            } else {
                emptyOrderMessage.classList.add('hidden');
                
                let itemsHTML = '';
                let subtotal = 0;
                
                order.forEach((item, index) => {
                    subtotal += item.price;
                    let itemDescription = item.description || ''; // Garante que description não seja undefined
                    let itemName = item.name;

                    if (item.type === 'promotion') {
                        itemName = `<i class="fas fa-tags text-red-600 mr-2"></i> ${item.name}`; // Ícone vermelho para promoções
                    } else if (item.type === 'half_pending') { // Explicitamente trata a meia pizza pendente
                        const sizeLabel = `${item.selected_slices} FATIAS`.toUpperCase();
                        itemName = `<b>${sizeLabel}</b>: ${item.name} (1ª Metade)`; // Indicador claro
                        itemDescription = `Aguardando 2ª metade`; // Descrição mais clara
                    } else if (item.selected_slices) {
                        const sizeLabel = `${item.selected_slices} FATIAS`.toUpperCase();
                        itemName = `<b>${sizeLabel}</b>: ${item.name}`;
                    }
                    
                    itemsHTML += `
                        <div class="flex justify-between items-center py-3 border-b border-gray-100">
                            <div class="flex-1">
                                <p class="font-medium">${itemName}</p>
                                <p class="text-sm text-gray-500">${itemDescription}</p>
                            </div>
                            <div class="flex items-center">
                                <span class="font-bold mr-4">R$ ${item.price.toFixed(2).replace('.', ',')}</span>
                                <button onclick="removeItem(${index})" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                orderItemsContainer.innerHTML = itemsHTML;
                
                const total = subtotal + deliveryFee;
                
                subtotalEl.textContent = 'R$ ' + subtotal.toFixed(2).replace('.', ',');
                totalEl.textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
            }
        }
        
        // Remover item do pedido
        function removeItem(index) {
            const removedItem = order[index];
            order.splice(index, 1);
            updateOrderDisplay();
            updateCartCount();

            // Se a meia pizza pendente for removida, reseta o estado
            if (removedItem && removedItem.id === 'pending-half-pizza') {
                firstHalfPizza = null;
                isSelectingSecondHalf = false;
                showTemporaryFeedback('Seleção de meia pizza cancelada.', 'bg-red-600'); // Mensagem e cor alteradas
            }
        }
        
        // Limpar todo o pedido
        function clearOrder() {
            order = [];
            updateOrderDisplay();
            updateCartCount();
            // Reseta o estado da meia pizza ao limpar o pedido
            firstHalfPizza = null;
            isSelectingSecondHalf = false;
        }
        
        // Atualizar contagem do carrinho
        function updateCartCount() {
            if (order.length > 0) {
                cartCount.textContent = order.length;
                cartCount.classList.remove('hidden');
            } else {
                cartCount.classList.add('hidden');
            }
        }
        
        // Função de finalização do pedido
        function checkout() {
            console.log("Checkout function called. Current order length:", order.length); // Debug log
            if (order.length === 0) {
                console.log("Order is empty. Showing message modal."); // Debug log
                showMessageModal('O seu pedido está vazio. Adicione itens antes de finalizar.');
                return;
            }
            
            // Verifica se há uma pizza meio a meio pendente
            if (isSelectingSecondHalf) {
                showMessageModal('Por favor, escolha a segunda metade da sua pizza antes de finalizar o pedido.');
                return;
            }

            // NOVA LÓGICA: Verifica se há alguma bebida no pedido
            const hasDrinks = order.some(item => item.category === 'bebidas');
            if (!hasDrinks) {
                displayDrinkSuggestionModal(); // Chama o novo modal de sugestão de bebidas
                return; // Interrompe o checkout para que o usuário possa escolher uma bebida
            }

            const phoneNumber = '5587996070638'; 
            let message = 'Olá! Gostaria de fazer o seguinte pedido:\n\n';
            let subtotal = 0;

            order.forEach(item => {
                let itemName = item.name;
                if (item.type === 'promotion') {
                    itemName = item.name.replace('<i class="fas fa-tags text-red-600 mr-2"></i> ', ''); // Remove o ícone para o WhatsApp
                } else if (item.selected_slices) {
                    itemName = `${item.selected_slices} FATIAS: ${item.name}`;
                }
                message += `- ${itemName}: R$ ${item.price.toFixed(2).replace('.', ',')}\n`;
                subtotal += item.price;
            });

            const total = subtotal + deliveryFee;

            message += `\nSubtotal: R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            message += `\nTaxa de entrega: R$ ${deliveryFee.toFixed(2).replace('.', ',')}`;
            message += `\nTotal: R$ ${total.toFixed(2).replace('.', ',')}`;
            message += '\n\nObrigado!';

            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            order = [];
            updateOrderDisplay();
            updateCartCount();
            closeOrderSidebar();
        }

        // Função para voltar ao menu
        function backToMenu() {
            closeOrderSidebar();
            document.getElementById('menu').scrollIntoView({ behavior: 'smooth' });
        }

        // Funções de Promoção
        function displayPromotionsPopup() {
            promotionsListEl.innerHTML = '';
            const activePromotions = allPromotionsData.filter(promo => promo.active && promo.promoPrice !== null);

            if (activePromotions.length > 0) {
                activePromotions.forEach(promo => {
                    const promoDiv = document.createElement('div');
                    promoDiv.className = 'promotion-item';
                    promoDiv.innerHTML = `
                        <h4>${promo.name}</h4>
                        <p>${promo.description}</p>
                        <span class="price">R$ ${promo.promoPrice.toFixed(2).replace('.', ',')}</span>
                        <button class="add-promo-to-order-btn px-3 py-1 bg-green-600 text-white rounded-full text-sm hover:bg-green-700 transition mt-2"
                                data-promo-id="${promo.id}">
                            Adicionar à Sacola
                        </button>
                    `;
                    promotionsListEl.appendChild(promoDiv);
                });
                document.querySelectorAll('.add-promo-to-order-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const promoId = this.dataset.promoId;
                        addPromotionToOrder(promoId);
                    });
                });
                promotionPopup.style.display = 'flex';
            } else {
                promotionPopup.style.display = 'none';
            }
        }

        function addPromotionToOrder(promoId) {
            const promotion = allPromotionsData.find(p => p.id === promoId);
            if (promotion) {
                order.push({
                    type: 'promotion',
                    name: promotion.name,
                    price: promotion.promoPrice,
                    description: promotion.description,
                    itemId: promotion.itemId
                });
                updateOrderDisplay();
                updateCartCount();
                promotionPopup.style.display = 'none';
                showTemporaryFeedback(`Promoção "${promotion.name}" adicionada ao pedido!`, 'bg-green-500'); // Usar feedback temporário
            } else {
                console.error('Promoção não encontrada:', promoId);
                showMessageModal('Erro ao adicionar promoção. Por favor, tente novamente.');
            }
        }

        function updatePromotionButtonVisibility() {
            const activePromotionsWithPrice = allPromotionsData.filter(promo => promo.active && promo.promoPrice !== null);
            if (activePromotionsWithPrice.length > 0) {
                promotionButton.style.display = 'flex';
            } else {
                promotionButton.style.display = 'none';
            }
        }

        // Listeners para fechar o modal de promoção
        closePromotionPopupBtn.addEventListener('click', function() {
            promotionPopup.style.display = 'none';
        });
        closePromotionPopupBtnBottom.addEventListener('click', function() {
            promotionPopup.style.display = 'none';
        });
        window.addEventListener('click', function(event) {
            if (event.target == promotionPopup) {
                promotionPopup.style.display = 'none';
            }
        });

        // Listener para o botão flutuante de promoção
        promotionButton.addEventListener('click', function() {
            displayPromotionsPopup();
        });

        // Funções do novo modal de sugestão de bebidas
        function displayDrinkSuggestionModal() {
            suggestedDrinksList.innerHTML = ''; // Limpa a lista antes de preencher
            const availableDrinks = allMenuData.filter(item => item.category === 'bebidas' && item.available);

            if (availableDrinks.length > 0) {
                // Pega as 3 primeiras bebidas disponíveis ou menos, se não houver 3
                const drinksToSuggest = availableDrinks.slice(0, 3); 
                drinksToSuggest.forEach(drink => {
                    const drinkItemHtml = `
                        <div class="suggested-drink-item">
                            <span class="drink-name">${drink.name}</span>
                            <span class="drink-price">R$ ${drink.basePrice.toFixed(2).replace('.', ',')}</span>
                            <button class="add-suggested-drink-btn" data-item-id="${drink.id}">Adicionar</button>
                        </div>
                    `;
                    suggestedDrinksList.insertAdjacentHTML('beforeend', drinkItemHtml);
                });

                // Adiciona listeners aos botões de adicionar bebida sugerida
                document.querySelectorAll('.add-suggested-drink-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const itemId = this.dataset.itemId;
                        const item = allMenuData.find(i => i.id === itemId);
                        if (item) {
                            addToOrder({
                                type: 'full',
                                name: item.name,
                                price: item.basePrice,
                                description: item.description,
                                category: item.category
                            });
                            drinkSuggestionModal.style.display = 'none'; // Fecha o modal após adicionar
                            // O checkout será revalidado na próxima tentativa, ou você pode chamar checkout() novamente aqui
                            // Se chamar checkout() aqui, remova o return no checkout() principal
                            // Para este caso, vamos deixar o usuário tentar finalizar novamente
                        }
                    });
                });
            } else {
                // Se não houver bebidas para sugerir, pode exibir uma mensagem diferente ou apenas o botão de continuar
                suggestedDrinksList.innerHTML = '<p class="text-gray-500">Nenhuma bebida disponível para sugestão no momento.</p>';
            }
            drinkSuggestionModal.style.display = 'flex'; // Exibe o modal
        }

        // Listener para fechar o modal de sugestão de bebidas
        closeDrinkSuggestionModalBtn.addEventListener('click', function() {
            drinkSuggestionModal.style.display = 'none';
        });

        // Listener para o botão "Continuar sem bebidas"
        proceedWithoutDrinksBtn.addEventListener('click', function() {
            drinkSuggestionModal.style.display = 'none';
            // Se o usuário optar por continuar sem bebidas, chamamos o checkout novamente
            // mas desta vez a condição `!hasDrinks` será ignorada (ou podemos adicionar uma flag)
            // Para simplificar, vamos permitir que o checkout original continue.
            // A forma mais robusta seria ter uma flag ou um parâmetro para checkout()
            // que indica que a verificação de bebidas deve ser ignorada para esta chamada.
            // Por enquanto, vamos chamar o checkout novamente.
            // ATENÇÃO: Isso pode levar a um loop se o usuário continuar clicando e não houver bebidas.
            // Uma solução melhor seria ter uma função `finalizeOrder()` separada.
            // Por simplicidade, para este exemplo, vamos chamar o checkout() novamente.
            const phoneNumber = '5587996070638'; 
            let message = 'Olá! Gostaria de fazer o seguinte pedido:\n\n';
            let subtotal = 0;

            order.forEach(item => {
                let itemName = item.name;
                if (item.type === 'promotion') {
                    itemName = item.name.replace('<i class="fas fa-tags text-red-600 mr-2"></i> ', ''); // Remove o ícone para o WhatsApp
                } else if (item.selected_slices) {
                    itemName = `${item.selected_slices} FATIAS: ${item.name}`;
                }
                message += `- ${itemName}: R$ ${item.price.toFixed(2).replace('.', ',')}\n`;
                subtotal += item.price;
            });

            const total = subtotal + deliveryFee;

            message += `\nSubtotal: R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            message += `\nTaxa de entrega: R$ ${deliveryFee.toFixed(2).replace('.', ',')}`;
            message += `\nTotal: R$ ${total.toFixed(2).replace('.', ',')}`;
            message += '\n\nObrigado!';

            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            order = [];
            updateOrderDisplay();
            updateCartCount();
            closeOrderSidebar();
        });


        // Sticky category bar logic (re-implemented for pizza categories)
        const categoryBtns = document.querySelectorAll('.category-btn');
        const categorySections = document.querySelectorAll('.pizza-category-section');
        let isScrollingFromClick = false; 
        let currentActiveCategoryByScroll = 'tradicionais'; 

        function getStickyHeaderHeight() {
            const stickyHeader = document.querySelector('.category-bar-mobile-sticky');
            return stickyHeader ? stickyHeader.offsetHeight : 0;
        }

        categoryBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const category = this.dataset.category;
                const targetId = this.dataset.targetId;
                setActiveCategoryButton(category);
                isScrollingFromClick = true;
                document.getElementById(targetId).scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Reseta a flag após um pequeno atraso para permitir que o IntersectionObserver funcione novamente
                setTimeout(() => {
                    isScrollingFromClick = false;
                }, 700); // Ajuste este tempo se o scroll for muito rápido/lento
            });
        });

        function setActiveCategoryButton(category) {
            categoryBtns.forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.remove('bg-gray-200', 'text-gray-800');
                    btn.classList.add('bg-red-600', 'text-white');
                    btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    btn.classList.remove('bg-red-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-800');
                }
            });
        }

        const categoryObserver = new IntersectionObserver((entries) => {
            if (isScrollingFromClick) {
                return;
            }
            let newActiveCategory = null;
            const stickyHeaderHeight = getStickyHeaderHeight();
            let bestMatchCategory = null;
            let smallestDistanceToTop = Infinity;

            entries.forEach(entry => {
                const section = entry.target;
                const category = section.id.replace('-section', '');
                const rect = section.getBoundingClientRect();

                // Calcula o topo da secção em relação à parte inferior do cabeçalho fixo.
                const sectionTopRelativeToStickyBottom = rect.top - stickyHeaderHeight;

                // Procuramos a secção cujo topo está exatamente ou ligeiramente acima da parte inferior do cabeçalho fixo.
                // Priorizamos as secções que estão atualmente visíveis e cujo topo está mais próximo de 0 ou ligeiramente negativo.
                if (entry.isIntersecting && sectionTopRelativeToStickyBottom <= 10) { // Pequeno buffer para precisão
                    // Se estiver no ou acima do cabeçalho fixo, e estiver mais próximo do que a melhor correspondência anterior
                    if (Math.abs(sectionTopRelativeToStickyBottom) < smallestDistanceToTop) {
                        smallestDistanceToTop = Math.abs(sectionTopRelativeToStickyBottom);
                        bestMatchCategory = category;
                    }
                }
            });

            // Se uma melhor correspondência foi encontrada, use-a.
            if (bestMatchCategory) {
                newActiveCategory = bestMatchCategory;
            } else {
                // Fallback: Se não houver interseção perfeita, encontre a secção mais acima que esteja pelo menos parcialmente visível.
                // Isso lida com casos em que a rolagem é muito rápida ou no topo/fundo da página.
                for (let i = 0; i < categorySections.length; i++) {
                    const section = categorySections[i];
                    const rect = section.getBoundingClientRect();
                    if (rect.bottom > 0 && rect.top < window.innerHeight) { // Se a secção estiver visível
                        newActiveCategory = section.id.replace('-section', '');
                        break; // Pega a primeira (mais acima visível)
                    }
                }
                // Se ainda não houver categoria e estiver no topo da página, assume 'tradicionais'
                if (!newActiveCategory && window.scrollY <= stickyHeaderHeight + 20 && categorySections.length > 0) {
                    newActiveCategory = 'tradicionais';
                }
            }
            
            if (newActiveCategory && newActiveCategory !== currentActiveCategoryByScroll) {
                setActiveCategoryButton(newActiveCategory);
                currentActiveCategoryByScroll = newActiveCategory;
            }
        }, {
            root: null,
            rootMargin: `-${getStickyHeaderHeight()}px 0px -50% 0px`, // Ajusta a margem da raiz para alinhar com o cabeçalho fixo
            threshold: [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1] // Observa todos os limiares para deteção mais granular
        });

        categorySections.forEach(section => {
            categoryObserver.observe(section);
        });

        // Removido o listener de scroll explícito, pois o IntersectionObserver já lida com a deteção de rolagem.
        // let scrollTimeout;
        // window.addEventListener('scroll', () => {
        //     clearTimeout(scrollTimeout);
        //     scrollTimeout = setTimeout(() => {
        //         // Isso fará com que os IntersectionObservers reavaliem suas interseções.
        //     }, 50);
        // });
        // Fim da lógica da barra de categorias

        // Inicialização
        document.addEventListener('DOMContentLoaded', async function() {
            allMenuData = await loadMenuFromSheet(); // Carrega todos os itens do cardápio (pizzas e bebidas)
            allPromotionsData = await loadPromotionsFromSheet(); // Carrega promoções
            
            populateMenu(allMenuData); // Popula o cardápio com todos os itens
            updatePromotionButtonVisibility(); // Atualiza a visibilidade do botão de promoção
            updateCartCount(); // Garante que a contagem do carrinho esteja correta ao carregar
            updateOrderDisplay(); // Garante que o pedido esteja correto ao carregar

            // Dispara um evento de rolagem após um curto atraso para garantir que o observer seja executado
            setTimeout(() => {
                window.dispatchEvent(new Event('scroll'));
            }, 100);
        });
    </script>
</body>
</html>
